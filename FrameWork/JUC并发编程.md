> âœ¨ä½œè€…ï¼šçŒ«åäºŒæ‡¿
>
> â¤ï¸â€ğŸ”¥è´¦å·ï¼š[CSDN](https://blog.csdn.net/qq_56098191) ã€[æ˜é‡‘](https://juejin.cn/user/3320978695270526) ã€[ä¸ªäººåšå®¢](https://kongshier.github.io/) ã€[Github](https://github.com/kongshier) 
>
> ğŸ‰å…¬ä¼—å·ï¼šçŒ«åäºŒæ‡¿

[å­¦ä¹ åœ°å€](https://www.bilibili.com/video/BV1Kw411Z7dF)

# å†™åœ¨æœ€å‰

JUCï¼ˆ`Java Util Concurrent`ï¼‰å­¦ä¹ å†…å®¹æ¡†æ¶ï¼š

~~~mermaid
graph TB
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a1(JUCæ¦‚å¿µ)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a12(Lockæ¥å£)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a13(çº¿ç¨‹é—´é€šä¿¡)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a14(é›†åˆçš„çº¿ç¨‹å®‰å…¨)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a15(å¤šçº¿ç¨‹é”)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a16(Callableæ¥å£)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a17(JUCä¸‰å¤§è¾…åŠ©ç±»)
a17(JUCä¸‰å¤§è¾…åŠ©ç±»)-->a171(CountDowLatch)
a17(JUCä¸‰å¤§è¾…åŠ©ç±»)-->a172(CyclicBarrier)
a17(JUCä¸‰å¤§è¾…åŠ©ç±»)-->a173(Semaphore)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a18(è¯»å†™é”:ReentrantReadWriteLock)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a19(é˜»å¡é˜Ÿåˆ—)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a20(ThreadPoolçº¿ç¨‹æ± )
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a21(Fork/Join æ¡†æ¶)
A(JUCé«˜å¹¶å‘ç¼–ç¨‹å†…å®¹)-->a22(CompletableFuture)
~~~



# 1ã€JUCæ¦‚è¿°

## 1.1 JUCæ¦‚å¿µ

JUCæ˜¯Java Util Concurrentçš„ç®€ç§°ï¼Œæ˜¯Java 5åŠä»¥åç‰ˆæœ¬ä¸­æ–°å¢çš„ç”¨äºæ”¯æŒé«˜å¹¶å‘ç¼–ç¨‹çš„åŒ…ã€‚JUCæä¾›äº†ä¸€äº›çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ã€åŸå­ç±»ã€é”ã€ä¿¡å·é‡ã€å€’è®¡æ•°å™¨ã€æ …æ ç­‰ç”¨äºå¹¶å‘ç¼–ç¨‹çš„ç±»å’Œæ¥å£ï¼Œä»¥å¸®åŠ©Javaå¼€å‘è€…ç¼–å†™é«˜æ•ˆã€å®‰å…¨ã€ç¨³å®šçš„å¤šçº¿ç¨‹ç¨‹åºã€‚

åœ¨ä¼ ç»Ÿçš„Javaå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå¼€å‘è€…ä½¿ç”¨synchronizedå…³é”®å­—æ¥ä¿è¯çº¿ç¨‹çš„åŒæ­¥å’Œåä½œï¼Œä½†æ˜¯synchronizedå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åªèƒ½ä½¿ç”¨åœ¨æ–¹æ³•æˆ–ä»£ç å—ä¸­ã€ä¸€æ—¦æŒæœ‰é”å°±æ— æ³•è¢«å…¶ä»–çº¿ç¨‹è·å–ç­‰ã€‚JUCæä¾›äº†æ›´åŠ çµæ´»ã€åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„åŒæ­¥æœºåˆ¶ï¼Œå¦‚Lockæ¥å£ã€Conditionæ¥å£ã€Semaphoreç±»ã€CountDownLatchç±»ã€CyclicBarrierç±»ç­‰ï¼Œå¯ä»¥æ›´å¥½åœ°å¸®åŠ©å¼€å‘è€…è§£å†³çº¿ç¨‹åŒæ­¥å’Œåä½œçš„é—®é¢˜ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒJUCè¿˜æä¾›äº†ä¸€äº›å¹¶å‘é›†åˆç±»å’ŒåŸå­ç±»ï¼Œè¿™äº›ç±»å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°è¿›è¡Œæ“ä½œï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®æ—¶çš„ç«äº‰é—®é¢˜ï¼Œæé«˜äº†å¹¶å‘ç¼–ç¨‹çš„æ•ˆç‡å’Œç¨³å®šæ€§ã€‚

æ€»çš„æ¥è¯´ï¼ŒJUCæä¾›äº†ä¸€ç»„å¼ºå¤§çš„å¹¶å‘ç¼–ç¨‹å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©Javaå¼€å‘è€…æ›´å¥½åœ°åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„å¹¶å‘æ€§èƒ½ï¼Œä»è€Œæ›´å¥½åœ°æ»¡è¶³ç°ä»£åº”ç”¨å¯¹é«˜å¹¶å‘å¤„ç†çš„éœ€æ±‚ã€‚

## 1.2 JUC å†…å®¹

JUCï¼ˆJava Util Concurrentï¼‰æ˜¯Java 5åŠä»¥åç‰ˆæœ¬ä¸­æ–°å¢çš„ç”¨äºæ”¯æŒé«˜å¹¶å‘ç¼–ç¨‹çš„åŒ…ï¼Œå…¶ä¸­åŒ…å«äº†å¾ˆå¤šç”¨äºå¹¶å‘ç¼–ç¨‹çš„ç±»å’Œæ¥å£ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š

1. å¹¶å‘é›†åˆç±»ï¼šJUCä¸­æä¾›äº†ä¸€äº›çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼Œå¦‚ConcurrentHashMapã€CopyOnWriteArrayListã€ConcurrentLinkedQueueç­‰ï¼Œè¿™äº›ç±»å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°è¿›è¡Œæ“ä½œï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®æ—¶çš„ç«äº‰é—®é¢˜ã€‚
2. åŸå­ç±»ï¼šJUCä¸­æä¾›äº†ä¸€äº›åŸå­ç±»ï¼Œå¦‚AtomicIntegerã€AtomicLongã€AtomicBooleanç­‰ï¼Œè¿™äº›ç±»å¯ä»¥ä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„åŸå­æ€§æ“ä½œï¼Œé¿å…äº†å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®æ—¶çš„ç«äº‰é—®é¢˜ã€‚
3. Lockæ¥å£ï¼šJUCä¸­æä¾›äº†ä¸€ç»„Lockæ¥å£åŠå…¶å®ç°ç±»ï¼Œå¦‚ReentrantLockã€ReentrantReadWriteLockç­‰ï¼ŒLockæ¥å£æä¾›äº†æ¯”synchronizedæ›´åŠ çµæ´»çš„é”æ“ä½œï¼Œå¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶çº¿ç¨‹çš„å¹¶å‘è®¿é—®ã€‚
4. Conditionæ¥å£ï¼šJUCä¸­æä¾›äº†Conditionæ¥å£ï¼Œå¯ä»¥ä¸Lockæ¥å£é…åˆä½¿ç”¨ï¼Œå®ç°æ›´åŠ çµæ´»çš„çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’æ“ä½œã€‚
5. Semaphoreç±»ï¼šSemaphoreæ˜¯ä¸€ç§è®¡æ•°ä¿¡å·é‡ï¼Œå¯ä»¥ç”¨æ¥é™åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°ã€‚
6. CountDownLatchç±»ï¼šCountDownLatchæ˜¯ä¸€ç§å€’è®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥å®ç°ç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆåå†æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚
7. CyclicBarrierç±»ï¼šCyclicBarrieræ˜¯ä¸€ç§æ …æ ï¼Œå¯ä»¥ç”¨æ¥ç­‰å¾…å¤šä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸ªçŠ¶æ€åå†ä¸€èµ·æ‰§è¡Œã€‚

JUCæä¾›çš„è¿™äº›ç±»å’Œæ¥å£ï¼Œå¯ä»¥å¸®åŠ©Javaå¼€å‘è€…æ›´å¥½åœ°ç¼–å†™é«˜æ•ˆã€å®‰å…¨ã€ç¨³å®šçš„å¤šçº¿ç¨‹ç¨‹åºï¼Œä»è€Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚



## 1.3 è¿›ç¨‹å’Œçº¿ç¨‹

### è¿›ç¨‹

è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªç¨‹åºï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºï¼Œä¸åŒçš„è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œäº’ç›¸ä¹‹é—´ä¸èƒ½è®¿é—®å½¼æ­¤çš„å†…å­˜ç©ºé—´ã€‚è¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„è¿›ç¨‹è°ƒåº¦å™¨æ¥å®ç°è¿›ç¨‹çš„è°ƒåº¦å’Œç®¡ç†ã€‚

### çº¿ç¨‹

çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«ç›¸åŒçš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºï¼Œå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œé€šä¿¡å’Œæ•°æ®å…±äº«ã€‚çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¼€é”€è¾ƒå°ï¼Œå¯ä»¥æ›´åŠ é«˜æ•ˆåœ°å®ç°å¹¶å‘ä»»åŠ¡ã€‚

ç”±äºè¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¼€é”€è¾ƒå¤§ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹çš„åº”ç”¨æ¯”å¤šè¿›ç¨‹çš„åº”ç”¨æ›´åŠ é«˜æ•ˆï¼Œå¯ä»¥æ›´å¥½åœ°åˆ©ç”¨è®¡ç®—æœºçš„èµ„æºï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚åŒæ—¶ï¼Œçº¿ç¨‹ä¹‹é—´çš„å…±äº«å†…å­˜å’Œæ•°æ®çš„æ“ä½œéœ€è¦è¿›è¡ŒåŒæ­¥å’Œäº’æ–¥ï¼Œå¦åˆ™ä¼šå‡ºç°æ•°æ®ç«äº‰å’Œæ­»é”ç­‰é—®é¢˜ï¼Œå› æ­¤åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­éœ€è¦æ³¨æ„çº¿ç¨‹çš„åŒæ­¥å’Œäº’æ–¥é—®é¢˜ã€‚

## 1.4 çº¿ç¨‹çŠ¶æ€

### 1.4.1 çº¿ç¨‹çŠ¶æ€æšä¸¾ç±»

1. NEWï¼š(æ–°å»º)
2. RUNNABLEï¼šï¼ˆå‡†å¤‡å°±ç»ªï¼‰
3. BLOCKEDï¼šï¼ˆé˜»å¡ï¼‰
4. WAITINGï¼šï¼ˆä¸è§ä¸æ•£ï¼‰
5. TIMED_WAITINGï¼šï¼ˆè¿‡æ—¶ä¸å€™ï¼‰
6. TERMINATEDï¼š(ç»ˆç»“)

é€šè¿‡ä¸€ä¸ªå°æ¡ˆä¾‹è¯´æ˜ä¸Šé¢çš„æšä¸¾å€¼

> ä½ å’Œä½ æœ‹å‹è¶Šå¥½ä¸€èµ·å‡ºå»ç©`ï¼ˆNEWæ–°å»ºçŠ¶æ€ï¼‰`ï¼Œä¸€åˆ‡å‡†å¤‡å°±ç»ª`ï¼ˆRUNNABLEï¼šå‡†å¤‡å°±ç»ªçŠ¶æ€ï¼‰`ï¼Œå‡ºå‘ä¹‹åï¼Œå‡ºç°äº†æ„å¤–ä½ åœ¨å¼€è½¦çš„è·¯ä¸Šå µè½¦äº†ï¼ˆ`BLOCKEDé˜»å¡ï¼‰`ï¼Œä½ ä»¬è¶Šå¥½çš„æ˜¯æ™šä¸Šçš„å…«ç‚¹è§é¢ï¼Œç”±äºé˜»å¡äº†ï¼Œä½ çš„æœ‹å‹æœ‰è¿˜åœ¨ç­‰ä½ `ï¼ˆWAITINGä¸è§ä¸æ•£ï¼‰`ï¼Œä¹Ÿæœ‰å¯èƒ½ä½ çš„æœ‹å‹å·²ç»èµ°äº†ä½ é‚£ä¹ˆä¹…è¿˜æ²¡æœ‰æ¥`ï¼ˆTIMED_WAITINGè¿‡æ—¶ä¸å€™ï¼‰`ï¼Œæœ€åå¯èƒ½æ˜¯æ„‰å¿«ç»“æŸè§é¢ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸æ„‰å¿«çš„ç»“æŸè¿™æ¬¡å‡ºè¡Œã€‚`ï¼ˆTERMINATEDç»ˆç»“ï¼‰`

### 1.4.2 waitã€sleep çš„åŒºåˆ«  

1. sleep æ˜¯ Thread çš„é™æ€æ–¹æ³•ï¼Œwait æ˜¯ Object çš„æ–¹æ³•ï¼Œä»»ä½•å¯¹è±¡å®ä¾‹éƒ½èƒ½è°ƒç”¨ã€‚ 
2. sleep ä¸ä¼šé‡Šæ”¾é”ï¼Œå®ƒä¹Ÿä¸éœ€è¦å ç”¨é”ã€‚wait ä¼šé‡Šæ”¾é”ï¼Œä½†è°ƒç”¨å®ƒçš„å‰ææ˜¯å½“å‰çº¿ç¨‹å æœ‰é”(å³ä»£ç è¦åœ¨ synchronized ä¸­)ã€‚ ï¼ˆåœ¨å“ªé‡Œç¡å°±åœ¨é‚£é‡Œé†’æ¥ï¼‰
3. å®ƒä»¬éƒ½å¯ä»¥è¢« interrupted æ–¹æ³•ä¸­æ–­ã€‚



## 1.5 å¹¶å‘ä¸å¹¶è¡Œ  

### 1.5.1 ä¸²è¡Œæ¨¡å¼  

ä¸²è¡Œè¡¨ç¤ºæ‰€æœ‰ä»»åŠ¡éƒ½ä¸€ä¸€æŒ‰å…ˆåé¡ºåºè¿›è¡Œã€‚

ä¸²è¡Œæ„å‘³ç€å¿…é¡»å…ˆè£…å®Œä¸€è½¦æŸ´æ‰èƒ½ è¿é€è¿™è½¦æŸ´ï¼Œåªæœ‰è¿é€åˆ°äº†ï¼Œæ‰èƒ½å¸ä¸‹è¿™è½¦æŸ´ï¼Œå¹¶ä¸”åªæœ‰å®Œæˆäº†è¿™æ•´ä¸ªä¸‰ä¸ªæ­¥éª¤ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚ ä¸²è¡Œæ˜¯ä¸€æ¬¡åªèƒ½å–å¾—ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚ 

### 1.5.2 å¹¶è¡Œæ¨¡å¼  

å¹¶è¡Œæ„å‘³ç€å¯ä»¥åŒæ—¶å–å¾—å¤šä¸ªä»»åŠ¡ï¼Œå¹¶åŒæ—¶å»æ‰§è¡Œæ‰€å–å¾—çš„è¿™äº›ä»»åŠ¡ã€‚

å¹¶è¡Œæ¨¡å¼ç›¸å½“äºå°†é•¿é•¿çš„ä¸€æ¡é˜Ÿåˆ—ï¼Œåˆ’åˆ†æˆäº†å¤šæ¡çŸ­é˜Ÿåˆ—ï¼Œæ‰€ä»¥å¹¶è¡Œç¼©çŸ­äº†ä»»åŠ¡é˜Ÿåˆ—çš„é•¿åº¦ã€‚å¹¶è¡Œçš„æ•ˆç‡ä»ä»£ç å±‚æ¬¡ä¸Šå¼ºä¾èµ–äºå¤šè¿›ç¨‹/å¤šçº¿ç¨‹ä»£ç ï¼Œä»ç¡¬ä»¶è§’åº¦ä¸Šåˆ™ä¾èµ–äºå¤šæ ¸ CPUã€‚

### 1.5.3 å¹¶å‘

 å¹¶å‘(concurrent)æŒ‡çš„æ˜¯å¤šä¸ªç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œçš„ç°è±¡ï¼Œæ›´ç»†åŒ–çš„æ˜¯å¤šè¿›ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œæˆ–è€…å¤šæŒ‡ä»¤å¯ä»¥åŒæ—¶è¿è¡Œã€‚ä½†è¿™ä¸æ˜¯é‡ç‚¹ï¼Œåœ¨æè¿°å¹¶å‘çš„æ—¶å€™ä¹Ÿä¸ä¼šå»æ‰£è¿™ç§å­—çœ¼æ˜¯å¦ç²¾ç¡®ï¼Œ==å¹¶å‘çš„é‡ç‚¹åœ¨äºå®ƒæ˜¯ä¸€ç§ç°è±¡==, ==å¹¶å‘æè¿° çš„æ˜¯å¤šè¿›ç¨‹åŒæ—¶è¿è¡Œçš„ç°è±¡==ã€‚ä½†å®é™…ä¸Šï¼Œå¯¹äºå•æ ¸å¿ƒ CPU æ¥è¯´ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„ "åŒæ—¶è¿è¡Œ" è¡¨ç¤ºçš„ä¸æ˜¯çœŸçš„åŒä¸€æ—¶åˆ»æœ‰å¤šä¸ªçº¿ç¨‹è¿è¡Œçš„ç°è±¡ï¼Œè¿™æ˜¯å¹¶è¡Œçš„æ¦‚å¿µï¼Œè€Œæ˜¯æä¾›ä¸€ç§åŠŸèƒ½è®©ç”¨æˆ·çœ‹æ¥å¤šä¸ªç¨‹åºåŒæ—¶è¿è¡Œèµ·æ¥äº†ï¼Œä½†å®é™…ä¸Šè¿™äº›ç¨‹åºä¸­çš„è¿›ç¨‹ä¸æ˜¯ä¸€ç›´éœ¸å  CPU çš„ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€ ä¼šåœä¸€ä¼šã€‚ è¦è§£å†³å¤§å¹¶å‘é—®é¢˜ï¼Œé€šå¸¸æ˜¯å°†å¤§ä»»åŠ¡åˆ†è§£æˆå¤šä¸ªå°ä»»åŠ¡, ç”±äºæ“ä½œç³»ç»Ÿå¯¹è¿›ç¨‹çš„è°ƒåº¦æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥åˆ‡åˆ†æˆå¤šä¸ªå°ä»»åŠ¡åï¼Œå¯èƒ½ä¼šä»ä»»ä¸€å°ä»»åŠ¡å¤„æ‰§è¡Œã€‚è¿™å¯èƒ½ä¼šå‡ºç°ä¸€äº›ç°è±¡ï¼š

1. å¯èƒ½å‡ºç°ä¸€ä¸ªå°ä»»åŠ¡æ‰§è¡Œäº†å¤šæ¬¡ï¼Œè¿˜æ²¡å¼€å§‹ä¸‹ä¸ªä»»åŠ¡çš„æƒ…å†µã€‚è¿™æ—¶ä¸€èˆ¬ä¼šé‡‡ç”¨é˜Ÿåˆ—æˆ–ç±»ä¼¼çš„æ•°æ®ç»“æ„æ¥å­˜æ”¾å„ä¸ªå°ä»»åŠ¡çš„æˆæœ
2. å¯èƒ½å‡ºç°è¿˜æ²¡å‡†å¤‡å¥½ç¬¬ä¸€æ­¥å°±æ‰§è¡Œç¬¬äºŒæ­¥çš„å¯èƒ½ã€‚è¿™æ—¶ï¼Œä¸€èˆ¬é‡‡ç”¨å¤šè·¯å¤ç”¨æˆ– å¼‚æ­¥çš„æ–¹å¼ï¼Œæ¯”å¦‚åªæœ‰å‡†å¤‡å¥½äº§ç”Ÿäº†äº‹ä»¶é€šçŸ¥æ‰æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚ 
3. å¯ä»¥å¤šè¿›ç¨‹/å¤šçº¿ç¨‹çš„æ–¹å¼å¹¶è¡Œæ‰§è¡Œè¿™äº›å°ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å•è¿›ç¨‹/å•çº¿ç¨‹æ‰§è¡Œè¿™ äº›å°ä»»åŠ¡ï¼Œè¿™æ—¶å¾ˆå¯èƒ½è¦é…åˆå¤šè·¯å¤ç”¨æ‰èƒ½è¾¾åˆ°è¾ƒé«˜çš„æ•ˆç‡



### 1.5.4 å°ç»“(é‡ç‚¹)  

#### å¹¶å‘ï¼š

åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç‚¹ 

ä¾‹å­ï¼šæ˜¥è¿æŠ¢ç¥¨ã€ç”µå•†ç§’æ€... 

#### å¹¶è¡Œï¼š

å¤šé¡¹å·¥ä½œä¸€èµ·æ‰§è¡Œï¼Œä¹‹åå†æ±‡æ€» 

ä¾‹å­ï¼šæ³¡æ–¹ä¾¿é¢ï¼Œä¸€è¾¹ç”µæ°´å£¶çƒ§æ°´ï¼Œä¸€è¾¹æ’•è°ƒæ–™å€’å…¥æ¡¶ä¸­



## 1.6 ç®¡ç¨‹

ç®¡ç¨‹(monitor)æ˜¯ä¿è¯äº†åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ç®¡ç¨‹å†…æ´»åŠ¨ï¼Œå³ç®¡ç¨‹å†…å®šä¹‰çš„æ“ä½œåœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨(ç”±ç¼–è¯‘å™¨å®ç°)ã€‚ä½†æ˜¯è¿™æ ·å¹¶ä¸èƒ½ä¿è¯è¿›ç¨‹ä»¥è®¾è®¡çš„é¡ºåºæ‰§è¡Œã€‚

JVM ä¸­åŒæ­¥æ˜¯åŸºäºè¿›å…¥å’Œé€€å‡ºç®¡ç¨‹(monitor)å¯¹è±¡å®ç°çš„ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªç®¡ç¨‹ (monitor)å¯¹è±¡ï¼Œç®¡ç¨‹(monitor)ä¼šéšç€ java å¯¹è±¡ä¸€åŒåˆ›å»ºå’Œé”€æ¯ æ‰§è¡Œçº¿ç¨‹é¦–å…ˆè¦æŒæœ‰ç®¡ç¨‹å¯¹è±¡ï¼Œç„¶åæ‰èƒ½æ‰§è¡Œæ–¹æ³•ï¼Œå½“æ–¹æ³•å®Œæˆä¹‹åä¼šé‡Šæ”¾ç®¡ç¨‹ï¼Œæ–¹ æ³•åœ¨æ‰§è¡Œæ—¶å€™ä¼šæŒæœ‰ç®¡ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å–åŒä¸€ä¸ªç®¡ç¨‹



## 1.7 ç”¨æˆ·çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹

### 1.7.1 ç”¨æˆ·çº¿ç¨‹

å¹³æ—¶ç”¨åˆ°çš„æ™®é€šçº¿ç¨‹ï¼Œè‡ªå®šä¹‰çº¿ç¨‹ 

### 1.7.2 å®ˆæŠ¤çº¿ç¨‹

è¿è¡Œåœ¨åå°ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶ å½“ä¸»çº¿ç¨‹ç»“æŸåï¼Œç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼ŒJVM å­˜æ´» å¦‚æœæ²¡æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œéƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ŒJVM ç»“æŸ

```java
/**
 * @author Shier 2023/2/21 12:38
 * ç”¨æˆ·çº¿ç¨‹
 */
public class UserThread {
    public static void main(String[] args) {
        Thread thread = new Thread(() -> {
            //isDaemon æ€•åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·çº¿ç¨‹
            System.out.println(Thread.currentThread().getName() + "::" + Thread.currentThread().isDaemon());
            // æ¥ä¸€ä¸ªæ­»å¾ªç¯
            while (true) {
            }
        }, "test");
        // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
        thread.setDaemon(true);// JVMå°†ä¼šç»“æŸè¿›ç¨‹ï¼Œè¿›è¡Œåå°è¿è¡Œ
        
        thread.start();
        System.out.println(Thread.currentThread().getName() + "::" + Thread.currentThread().isDaemon());
    }
}
```



# 2ã€Lock æ¥å£

## 2.1 Synchroniezd é”

synchronized æ˜¯ Java ä¸­çš„å…³é”®å­—ï¼Œæ˜¯ä¸€ç§åŒæ­¥é”ã€‚å®ƒä¿®é¥°çš„å¯¹è±¡æœ‰ä»¥ä¸‹å‡ ç§ï¼š 

1. ä¿®é¥°ä¸€ä¸ªä»£ç å—ï¼Œè¢«ä¿®é¥°çš„ä»£ç å—ç§°ä¸ºåŒæ­¥è¯­å¥å—ï¼Œå…¶ä½œç”¨çš„èŒƒå›´æ˜¯å¤§æ‹¬å·{} æ‹¬èµ·æ¥çš„ä»£ç ï¼Œä½œç”¨çš„å¯¹è±¡æ˜¯è°ƒç”¨è¿™ä¸ªä»£ç å—çš„å¯¹è±¡ï¼›
2. ä¿®é¥°ä¸€ä¸ªæ–¹æ³•ï¼Œè¢«ä¿®é¥°çš„æ–¹æ³•ç§°ä¸ºåŒæ­¥æ–¹æ³•ï¼Œå…¶ä½œç”¨çš„èŒƒå›´æ˜¯æ•´ä¸ªæ–¹æ³•ï¼Œä½œç”¨ çš„å¯¹è±¡æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ï¼›
3. ä¿®æ”¹ä¸€ä¸ªé™æ€çš„æ–¹æ³•ï¼Œå…¶ä½œç”¨çš„èŒƒå›´æ˜¯æ•´ä¸ªé™æ€æ–¹æ³•ï¼Œä½œç”¨çš„å¯¹è±¡æ˜¯è¿™ä¸ªç±»çš„ æ‰€æœ‰å¯¹è±¡ï¼›
4. ä¿®æ”¹ä¸€ä¸ªç±»ï¼Œå…¶ä½œç”¨çš„èŒƒå›´æ˜¯ synchronized åé¢æ‹¬å·æ‹¬èµ·æ¥çš„éƒ¨åˆ†ï¼Œä½œç”¨ä¸» çš„å¯¹è±¡æ˜¯è¿™ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡ã€‚

å¦‚æœä¸€ä¸ªä»£ç å—è¢« synchronized ä¿®é¥°äº†ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†å¯¹åº”çš„é”ï¼Œå¹¶æ‰§è¡Œè¯¥ä»£ç å—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿åªèƒ½ä¸€ç›´ç­‰å¾…ï¼Œç­‰å¾…è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œè€Œè¿™é‡Œè·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”åªä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š 

1. è·å–é”çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†è¯¥ä»£ç å—ï¼Œç„¶åçº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å æœ‰
2. çº¿ç¨‹æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ï¼Œæ­¤æ—¶ JVM ä¼šè®©çº¿ç¨‹è‡ªåŠ¨é‡Šæ”¾é”ã€‚

é‚£ä¹ˆå¦‚æœè¿™ä¸ªè·å–é”çš„çº¿ç¨‹ç”±äºè¦ç­‰å¾… IO æˆ–è€…å…¶ä»–åŸå› ï¼ˆæ¯”å¦‚è°ƒç”¨ sleep æ–¹æ³•ï¼‰è¢«é˜»å¡äº†ï¼Œä½†æ˜¯åˆæ²¡æœ‰é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿åªèƒ½å¹²å·´å·´åœ°ç­‰å¾…ï¼Œè¯•æƒ³ä¸€ ä¸‹ï¼Œè¿™å¤šä¹ˆå½±å“ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚ å› æ­¤å°±éœ€è¦æœ‰ä¸€ç§æœºåˆ¶å¯ä»¥ä¸è®©ç­‰å¾…çš„çº¿ç¨‹ä¸€ç›´æ— æœŸé™åœ°ç­‰å¾…ä¸‹å»ï¼ˆæ¯”å¦‚åªç­‰ å¾…ä¸€å®šçš„æ—¶é—´æˆ–è€…èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼‰ï¼Œé€šè¿‡ Lock å°±å¯ä»¥åŠåˆ°ã€‚

### 2.1.1 å¤šçº¿ç¨‹ç¼–ç¨‹æ­¥éª¤

1. åˆ›å»ºèµ„æºç±»ï¼Œåœ¨èµ„æºç±»ä¸­åˆ›å»ºå±æ€§å’Œæ“ä½œæ–¹æ³•ï¼ˆä¸Šéƒ¨ï¼‰
2. åœ¨èµ„æºåˆ—ä¸­æ“ä½œæ–¹æ³•



ä¾‹å­å”®ç¥¨å‘˜ä¹°ç¥¨

```java
package com.shier.sync;

/**
 * @author Shier 2023/2/21 13:07
 */

// 1 åˆ›å»ºèµ„æºç±»
class Ticket {
    // åˆ›å»ºå±æ€§
    private int number = 30;

    // åŒæ­¥æ–¹æ³•
    public synchronized void sale() {
        if (number > 0) {
            System.out.println(Thread.currentThread().getName() + "å–ç¬¬" + (number--) + "å¼ ç¥¨ï¼Œå‰©ä½™ï¼š" + number);
        }
    }
}


public class SaleTicket {
    public static void main(String[] args) {
        // è°ƒç”¨èµ„æºç±»
        Ticket ticket = new Ticket();
        // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 40; i++) {
                    ticket.sale();
                }
            }
        }, "1å·").start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 40; i++) {
                    ticket.sale();
                }
            }
        }, "2å·").start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 40; i++) {
                    ticket.sale();
                }
            }
        }, "3å·").start();
    }
}
```



## 2.2 ä»€ä¹ˆæ˜¯Lock 

Lock é”å®ç°æä¾›äº†æ¯”ä½¿ç”¨åŒæ­¥æ–¹æ³•å’Œè¯­å¥å¯ä»¥è·å¾—çš„æ›´å¹¿æ³›çš„é”æ“ä½œã€‚å®ƒä»¬å… è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯èƒ½å…·æœ‰éå¸¸ä¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”å¯èƒ½æ”¯æŒå¤šä¸ªå…³è”çš„æ¡ä»¶å¯¹ è±¡ã€‚Lock æä¾›äº†æ¯” synchronized æ›´å¤šçš„åŠŸèƒ½ã€‚



### Lock ä¸çš„ Synchronized åŒºåˆ«

Lock ä¸æ˜¯ Java è¯­è¨€å†…ç½®çš„ï¼Œsynchronized æ˜¯ Java è¯­è¨€çš„å…³é”®å­—ï¼Œå› æ­¤æ˜¯å†…ç½®ç‰¹æ€§ã€‚

Lock æ˜¯ä¸€ä¸ªç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»å¯ä»¥å®ç°åŒæ­¥è®¿é—®ï¼› 

Lock å’Œ synchronized æœ‰ä¸€ç‚¹éå¸¸å¤§çš„ä¸åŒï¼Œ==é‡‡ç”¨ synchronized ä¸éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”==ï¼Œå½“ synchronized æ–¹æ³•æˆ–è€… synchronized ä»£ç å—æ‰§è¡Œå®Œä¹‹åï¼Œ ç³»ç»Ÿä¼šè‡ªåŠ¨è®©çº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å ç”¨ï¼›==è€Œ Lock åˆ™å¿…é¡»è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”==ï¼Œå¦‚æœæ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°æ­»é”ç°è±¡ã€‚

> å°±å¥½æ¯”å¦‚ä¸Šå•æ‰€ï¼Œå¦‚æœä½ è¦å»ä¸Šå•æ‰€ï¼Œå°±å¾—å…ˆåˆ¤æ–­å•æ‰€æ˜¯å¦æœ‰äººï¼Œå¦‚æœæœ‰äººå°±å¾—ç”³è¯·ï¼ˆå«ä»–ï¼‰ï¼Œåˆ«äººå‡ºæ¥äº†å°±ä¼šæŠŠé—¨æ‰“å¼€å°±æ˜¯é‡Šæ”¾é”ï¼Œä½ è¿›å»äº†å°±ä¼šæŠŠé—¨å…³ä¸Šï¼ˆä¸Šé”ï¼‰ï¼Œç­‰ä½ å®Œäº‹ä¹‹åï¼Œå°±ä¼šå¼€é—¨ï¼ˆä¸»åŠ¨é‡Šæ”¾é”ï¼‰ã€‚



### 2.2.1  lock æ–¹æ³•

lock()æ–¹æ³•æ˜¯å¹³å¸¸ä½¿ç”¨å¾—æœ€å¤šçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨æ¥è·å–é”ã€‚å¦‚æœé”å·²è¢«å…¶ä»– çº¿ç¨‹è·å–ï¼Œåˆ™è¿›è¡Œç­‰å¾…ã€‚ é‡‡ç”¨ Lockï¼Œå¿…é¡»ä¸»åŠ¨å»é‡Šæ”¾é”ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚å› æ­¤ä¸€ èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ Lock å¿…é¡»åœ¨ try{}catch{}å—ä¸­è¿›è¡Œï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”çš„æ“ä½œæ”¾åœ¨ finally å—ä¸­è¿›è¡Œï¼Œä»¥ä¿è¯é”ä¸€å®šè¢«è¢«é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”çš„å‘ç”Ÿã€‚

~~~java
Lock lock = ....;    
// ä¸Šé”
lock.lock();
try {
    if (number > 0) {
        System.out.println(Thread.currentThread().getName() + "å–ç¬¬" + (number--) + "å¼ ç¥¨ï¼Œå‰©ä½™ï¼š" + number);
    }
} finally {
    // è§£é”
    lock.lock();
}
~~~



### 2.2.2 ReentrantLock

ReentrantLockï¼Œæ„æ€æ˜¯â€œå¯é‡å…¥é”â€ï¼Œå…³äºå¯é‡å…¥é”çš„æ¦‚å¿µå°†åœ¨åé¢è®²è¿°ã€‚ ReentrantLock æ˜¯å”¯ä¸€å®ç°äº† Lock æ¥å£çš„ç±»ï¼Œå¹¶ä¸” ReentrantLock æä¾›äº†æ›´ å¤šçš„æ–¹æ³•ã€‚ä¸‹é¢é€šè¿‡ä¸€äº›å®ä¾‹çœ‹å…·ä½“çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚

```java
/**
 * @author Shier 2023/2/21 13:07
 */
// 1 åˆ›å»ºèµ„æºç±»
class Ticket {
    // åˆ›å»ºå±æ€§,ç¥¨çš„æ•°é‡
    private int number = 30;
    // åˆ›å»ºå¯é‡å…¥é”
    private final ReentrantLock lock = new ReentrantLock();

    // åŒæ­¥æ–¹æ³•
    public void sale() {
        // ä¸Šé”
        lock.lock();
        try {
            if (number > 0) {
                System.out.println(Thread.currentThread().getName() + "å–ç¬¬" + (number--) + "å¼ ç¥¨ï¼Œå‰©ä½™ï¼š" + number);
            }
        } finally {
            // è§£é”
            lock.lock();
        }
    }
}

public class LockSaleTicket {
    public static void main(String[] args) {
        // è°ƒç”¨èµ„æºç±»,
        Ticket ticket = new Ticket();
        // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹
        new Thread(()->{
            for (int i = 0; i < 30; i++) {
                ticket.sale();
            }
        },"1å·").start();

        new Thread(()->{
            for (int i = 0; i < 30; i++) {
                ticket.sale();
            }
        },"2å·").start();
        
        new Thread(()->{
            for (int i = 0; i < 30; i++) {
                ticket.sale();
            }
        },"3å·").start();
    }
}
```

### 2.2.3 newCondition (æ¡ä»¶å”¤é†’çº¿ç¨‹)

å…³é”®å­— synchronized ä¸ wait() / notify()è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€èµ·ä½¿ç”¨å¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ï¼Œ Lock é”çš„ newContition()æ–¹æ³•è¿”å› Condition å¯¹è±¡ï¼ŒCondition ç±»ä¹Ÿå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚ ç”¨ notify()é€šçŸ¥æ—¶ï¼ŒJVM ä¼šéšæœºå”¤é†’æŸä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œ ä½¿ç”¨ Condition ç±»å¯ä»¥è¿›è¡Œé€‰æ‹©æ€§é€šçŸ¥ï¼Œ Condition æ¯”è¾ƒå¸¸ç”¨çš„ä¸¤ä¸ªæ–¹æ³•ï¼š

1. await()ä¼šä½¿å½“å‰çº¿ç¨‹ç­‰å¾…,åŒæ—¶ä¼šé‡Šæ”¾é”,å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨`signal()`æ—¶ï¼Œçº¿ç¨‹ä¼šé‡ æ–°è·å¾—é”å¹¶ç»§ç»­æ‰§è¡Œã€‚ 
2. signal()ç”¨äºå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚



### 2.2.4 ReadWriteLock

ReadWriteLock ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨å®ƒé‡Œé¢åªå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•

~~~
Lock readLock(); // åªè¯»é”
Lock writeLock(); // å†™é”
~~~

ä¸€ä¸ªç”¨æ¥è·å–è¯»é”ï¼Œä¸€ä¸ªç”¨æ¥è·å–å†™é”ã€‚ä¹Ÿå°±æ˜¯è¯´å°†æ–‡ä»¶çš„è¯»å†™æ“ä½œåˆ†å¼€ï¼Œåˆ†æˆ2ä¸ªé”æ¥åˆ†é…ç»™çº¿ç¨‹ï¼Œä»è€Œä½¿å¾—å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿›è¡Œè¯»æ“ä½œã€‚ä¸‹é¢çš„ ReentrantReadWriteLock å®ç°äº† ReadWriteLock æ¥å£ã€‚ ReentrantReadWriteLock é‡Œé¢æä¾›äº†å¾ˆå¤šä¸°å¯Œçš„æ–¹æ³•ï¼Œä¸è¿‡æœ€ä¸»è¦çš„æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šreadLock()å’Œ writeLock()ç”¨æ¥è·å–è¯»é”å’Œå†™é”ã€‚

==PS==

- å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹å·²ç»å ç”¨äº†è¯»é”ï¼Œåˆ™æ­¤æ—¶å…¶ä»–çº¿ç¨‹å¦‚æœè¦ç”³è¯·å†™é”ï¼Œåˆ™ç”³è¯·å†™é”çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…é‡Šæ”¾è¯»é”ã€‚ 
- å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹å·²ç»å ç”¨äº†å†™é”ï¼Œåˆ™æ­¤æ—¶å…¶ä»–çº¿ç¨‹å¦‚æœç”³è¯·å†™é”æˆ–è€…è¯»é”ï¼Œåˆ™ç”³è¯·çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…é‡Šæ”¾å†™é”ã€‚



## 2.3 Lock æ€»ç»“

Lock å’Œ synchronized æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š 

1. Lock æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè€Œ synchronized æ˜¯ Java ä¸­çš„å…³é”®å­—ï¼Œsynchronized æ˜¯å†… ç½®çš„è¯­è¨€å®ç°ï¼› 
2. synchronized åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹å æœ‰çš„é”ï¼Œå› æ­¤ä¸ä¼šå¯¼è‡´æ­»é”ç° è±¡å‘ç”Ÿï¼›è€Œ Lock åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¦‚æœæ²¡æœ‰ä¸»åŠ¨é€šè¿‡ unLock()å»é‡Šæ”¾é”ï¼Œåˆ™å¾ˆ å¯èƒ½é€ æˆæ­»é”ç°è±¡ï¼Œå› æ­¤ä½¿ç”¨ Lock æ—¶éœ€è¦åœ¨ finally å—ä¸­é‡Šæ”¾é”ï¼› 
3. Lock å¯ä»¥è®©ç­‰å¾…é”çš„çº¿ç¨‹å“åº”ä¸­æ–­ï¼Œè€Œ synchronized å´ä¸è¡Œï¼Œä½¿ç”¨ synchronized æ—¶ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œä¸èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼›
4. é€šè¿‡ Lock å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰æˆåŠŸè·å–é”ï¼Œè€Œ synchronized å´æ— æ³•åŠåˆ°ã€‚ 
5. Lock å¯ä»¥æé«˜å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»æ“ä½œçš„æ•ˆç‡ã€‚ åœ¨æ€§èƒ½ä¸Šæ¥è¯´ï¼Œå¦‚æœç«äº‰èµ„æºä¸æ¿€çƒˆï¼Œä¸¤è€…çš„æ€§èƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œè€Œå½“ç«äº‰èµ„æº éå¸¸æ¿€çƒˆæ—¶ï¼ˆå³æœ‰å¤§é‡çº¿ç¨‹åŒæ—¶ç«äº‰ï¼‰ï¼Œæ­¤æ—¶ Lock çš„æ€§èƒ½è¦è¿œè¿œä¼˜äº synchronizedã€‚



# 3ã€ çº¿ç¨‹é—´é€šä¿¡

çº¿ç¨‹é—´é€šä¿¡çš„æ¨¡å‹æœ‰ä¸¤ç§ï¼š==å…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’==ï¼Œä»¥ä¸‹æ–¹å¼éƒ½æ˜¯åŸºæœ¬è¿™ä¸¤ç§æ¨¡å‹æ¥å®ç°çš„ã€‚æˆ‘ä»¬æ¥åŸºæœ¬ä¸€é“é¢è¯•å¸¸è§çš„é¢˜ç›®æ¥åˆ†æ

## 3.1 å¤šçº¿ç¨‹ç¼–ç¨‹æ­¥éª¤

1. åˆ›å»ºèµ„æºç±»ï¼Œåœ¨èµ„æºç±»ä¸­åˆ›å»ºå±æ€§å’Œæ“ä½œæ–¹æ³•ï¼ˆä¸Šéƒ¨ï¼‰
2. åœ¨èµ„æºåˆ—ä¸­æ“ä½œæ–¹æ³•ï¼ˆä¸­éƒ¨ï¼‰
   1. åˆ¤æ–­ï¼ˆæ˜¯å¦ç¬¦åˆå½“å‰çš„çŠ¶æ€ï¼‰
   2. å¹²æ´» ï¼ˆå…·ä½“å†…å®¹ï¼‰
   3. é€šçŸ¥ï¼ˆå‘Šè¯‰å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå€¼å·²ç»æ”¹å˜ï¼‰
3. åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨èµ„æºç±»çš„æ“ä½œæ–¹æ³•ï¼ˆä¸‹éƒ¨ï¼‰
4. é˜²æ­¢è™šå‡å”¤é†’é—®é¢˜

ä¾‹å­ï¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œå®ç°å¯¹ä¸€ä¸ªåˆå§‹å€¼æ˜¯0çš„å˜é‡çš„æ“ä½œï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å€¼ + 1 ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯¹å€¼ -1 

### ä½¿ç”¨synchronizationå®ç°ï¼š

```java
package com.shier.sync;

/**
 * @author Shier 2023/2/21 13:07
 */

// ç¬¬ä¸€æ­¥åˆ›å»ºèµ„æºç±»
class Share {
    // åˆ›å»ºä¸€ä¸ªå±æ€§ é»˜è®¤å€¼ä¸º 0
    private int num = 0;

    // å¯¹å±æ€§åŠ ä¸€çš„æ–¹æ³•
    public synchronized void increase() throws InterruptedException {
        // åˆ¤æ–­
        if (num == 1) {
            // ç­‰å¾…
            this.wait();
        }
        // å¹²æ´»
        num++;
        System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + num);
        // é€šçŸ¥
        this.notifyAll();
    }

    // å¯¹å±æ€§å‡ä¸€çš„æ–¹æ³•
    public synchronized void decrease() throws InterruptedException {
        // åˆ¤æ–­
        if (num == 0) {
            // ç­‰å¾…
            this.wait();
        }
        // å¹²æ´»
        num--;
        System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + num);
        // é€šçŸ¥
        this.notifyAll();
    }
}

public class ThreadSingleCommunication {
    public static void main(String[] args) {
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œ è°ƒç”¨èµ„æºç±»çš„çº¿ç¨‹
        Share share = new Share();
        new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                try {
                    share.decrease();// å‡ä¸€
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "å‡ä¸€çº¿ç¨‹").start();

        new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                try {
                    share.increase();// åŠ ä¸€
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "åŠ ä¸€çº¿ç¨‹").start();
    }
}
```

ä»¥ä¸Šçš„ä»£ç å­˜åœ¨ç€ä¸€å®šçš„é—®é¢˜ï¼šå¦‚æœæ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œæ¯”å¦‚å››ä¸ªçº¿ç¨‹å°±ä¸èƒ½å‡ºç° 1010çš„æ•ˆæœäº†ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†è™šå‡å”¤é†’ï¼Œæ‰€ä»¥è¯´å¾—å»æŒ‡å®šçº¿ç¨‹æ‰§è¡Œ

```java
  // å¯¹å±æ€§åŠ ä¸€çš„æ–¹æ³•
    public synchronized void increase() throws InterruptedException {
        // ä½¿ç”¨whileå¾ªç¯ä¸­é¿å…è™šå‡å”¤é†’
        while (num == 1) {
            // ç­‰å¾…
            this.wait();
        }
        // å¹²æ´»
        num++;
        System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + num);
        // é€šçŸ¥
        this.notifyAll();
    }
```

### ä½¿ç”¨Lock å®ç°

```java
/**
 * @author Shier 2023/2/21 16:10
 */
// å®šä¹‰ä¸€ä¸ªèµ„æºç±»
class Share {
    // å±æ€§
    private int number = 0;

    // åˆ›å»ºé”
    private Lock lock = new ReentrantLock();

    // åˆ›å»ºé’¥åŒ™
    private Condition condition = lock.newCondition();

    // åŠ ä¸€æ–¹æ³•
    public void increase() throws InterruptedException {
        //ä¸Šé”
        lock.lock();
        try {
            // é¿å…è™šå‡å”¤é†’
            while (number != 0) {
                condition.await();
            }
            number++;
            System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + number);
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }

    // å‡ä¸€æ–¹æ³•
    public void decrease() throws InterruptedException {
        //ä¸Šé”
        lock.lock();
        try {
            // é¿å…è™šå‡å”¤é†’
            while (number != 1) {
                condition.await();
            }
            // å‡ä¸€æ“ä½œ
            number--;
            System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + number);
            // å”¤é†’å…¶ä»–çº¿ç¨‹
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }
}
```



## 3.2 çº¿ç¨‹é—´å®šåˆ¶åŒ–é€šä¿¡

é—®é¢˜å¼•å…¥ï¼šå¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹Aã€Bã€Cï¼ŒA çº¿ç¨‹æ‰“å° 5 æ¬¡ï¼ŒB çº¿ç¨‹æ‰“å° 10 æ¬¡ï¼ŒC çº¿ç¨‹æ‰“å° 15 æ¬¡ï¼ŒæŒ‰ç…§æ­¤é¡ºåºå¾ªç¯ 10 è½®

![04-çº¿ç¨‹å®šåˆ¶åŒ–é€šä¿¡](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/04-%E7%BA%BF%E7%A8%8B%E5%AE%9A%E5%88%B6%E5%8C%96%E9%80%9A%E4%BF%A1.png)



```java
/**
 * @author Shier 2023/2/21 17:10
 */
// èµ„æºç±»
class ShareResource {
    // æ ‡å¿—ä½
    private int flag = 1;
    // åˆ›å»ºlocké”
    private Lock lock = new ReentrantLock();=
    // åˆ›å»ºcondition
    private Condition c1 = lock.newCondition();
    private Condition c2 = lock.newCondition();
    private Condition c3 = lock.newCondition();
    // åˆ›å»ºæ‰“å°äº”æ¬¡çš„æ–¹æ³•
    public void printFive(int loop) throws InterruptedException {
        // ä¸Šé”
        lock.lock();
        try {
            // é¿å…è™šå‡å”¤é†’
            while (flag != 1) {
                c1.await();
            }
            for (int i = 1; i <= 5; i++) {
                System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + i + "" + "ç¬¬" + loop + "æ¬¡");
            }
            flag = 2;
            // å”¤é†’c2
            c2.signal();
        } finally {
            lock.unlock();
        }
    }

    // åˆ›å»ºæ‰“å°10æ¬¡çš„æ–¹æ³•
    public void printTen(int loop) throws InterruptedException {
        // ä¸Šé”
        lock.lock();
        try {
            // é¿å…è™šå‡å”¤é†’
            while (flag != 2) {
                c2.await();
            }
            for (int i = 1; i <= 10; i++) {
                System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + i + "" + "ç¬¬" + loop + "æ¬¡");
            }
            flag = 3;
            // å”¤é†’c3
            c3.signal();
        } finally {
            lock.unlock();
        }
    }

    // åˆ›å»ºæ‰“å°15æ¬¡çš„æ–¹æ³•
    public void printFifth(int loop) throws InterruptedException {
        // ä¸Šé”
        lock.lock();
        try {
            // é¿å…è™šå‡å”¤é†’
            while (flag != 3) {
                c3.await();
            }
            for (int i = 1; i <= 15; i++) {
                System.out.println(Thread.currentThread().getName() + "å½“å‰å€¼ï¼š" + i + "" + "ï¼Œç¬¬" + loop + "æ¬¡");
            }
            flag = 1;
            // å”¤é†’ c1
            c1.signal();
        } finally {
            lock.unlock();
        }
    }
}

public class ThreadDemo {
    public static void main(String[] args) {
        ShareResource shareResource = new ShareResource();
        // è°ƒç”¨å‡ æ¬¡
        int loop = 5;
        new Thread(() -> {
            for (int i = 1; i <= loop; i++) {
                try {
                    shareResource.printFive(i);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "1å·çº¿ç¨‹").start();
        new Thread(() -> {
            for (int i = 1; i <= loop; i++) {
                try {
                    shareResource.printTen(i);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "2å·çº¿ç¨‹").start();
        new Thread(() -> {
            for (int i = 1; i <= loop; i++) {
                try {
                    shareResource.printFifth(i);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "3å·çº¿ç¨‹").start();
    }
}
```



# 4ã€é›†åˆçš„çº¿ç¨‹å®‰å…¨



ArrayList çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜å¼•å‡º

```java
/**
 * @author Shier 2023/2/21 17:59
 */

public class ThreadSecurity {
    public static void main(String[] args) {
        // å¤šä¸ªçº¿ç¨‹å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ä¼šå‡ºç°å¼‚å¸¸
        ArrayList<String> arrayList = new ArrayList<>();
        for (int i = 0; i < 30; i++) {
            new Thread(() -> {
                arrayList.add(UUID.randomUUID().toString().substring(0, 3));
                System.out.println(arrayList);
            }, String.valueOf(i)).start();
        }
    }
}
```

è¿è¡Œä¼šå‡ºç°ä¸€ä¸‹çš„æŠ¥é”™å¼‚å¸¸ï¼š==å¹¶å‘ä¿®æ”¹å¼‚å¸¸==

![image-20230221180446802](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230221180446802.png)

è§£å†³çº¿ç¨‹çš„å¹¶å‘ä¿®æ”¹å¼‚å¸¸æœ‰åŸºæœ¬çš„ä¸‰ç§

1. Vertor
2. Collections
3. CopyOnWriteArrayList

é¦–å…ˆçœ‹ç¬¬ä¸€ç§

## 4.1 Vertor å’Œ Collections

Vector æ˜¯çŸ¢é‡é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ JDK1.0 ç‰ˆæœ¬æ·»åŠ çš„ç±»ã€‚ç»§æ‰¿äº AbstractListï¼Œå®ç°äº† List, RandomAccess, Cloneable è¿™äº›æ¥å£ã€‚ Vector ç»§æ‰¿äº† AbstractListï¼Œ å®ç°äº†Listï¼›æ‰€ä»¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ”¯æŒç›¸å…³çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€éå†ç­‰åŠŸ èƒ½ã€‚ Vector å®ç°äº† RandmoAccess æ¥å£ï¼Œå³æä¾›äº†éšæœºè®¿é—®åŠŸèƒ½ã€‚ RandmoAccess æ˜¯ java ä¸­ç”¨æ¥è¢« List å®ç°ï¼Œä¸º List æä¾›å¿«é€Ÿè®¿é—®åŠŸèƒ½çš„ã€‚åœ¨ Vector ä¸­ï¼Œæˆ‘ä»¬å³å¯ä»¥é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡ï¼›è¿™å°±æ˜¯å¿«é€Ÿéšæœºè®¿é—®ã€‚ Vector å®ç°äº† Cloneable æ¥å£ï¼Œå³å®ç° clone()å‡½æ•°ã€‚å®ƒèƒ½è¢«å…‹éš†

==å’Œ ArrayList ä¸åŒï¼ŒVector ä¸­çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚== 

1ã€å°†ä¸Šé¢çš„ä»£ç çš„ArrayList æ”¹æˆ Vertor

~~~java
List<String> list = new Vertor<>();
~~~

å°±ä¸ä¼šå‡ºç°å¹¶å‘ä¿®æ”¹å¼‚å¸¸

å› ä¸ºVertorä¸­çš„add æ˜¯ä½¿ç”¨ synchronization åŒæ­¥é”å…³é”®å­—ä¿®é¥°ï¼Œæ‰€ä»¥è¯´ä¸ä¼šå‡ºç°å¼‚å¸¸

2ã€åŒæ ·ä¹Ÿè¿˜å¯ä»¥ä½¿ç”¨Collections å·¥å…·ç±»æ¥è¿›è¡Œé¿å…å¼‚å¸¸ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåŒæ­¥çš„é›†åˆ

~~~java
List<String> arrayList = Collections.synchronizedList(new ArrayList<>());
~~~

ä½†æ˜¯ä»¥ä¸Šä¸¤ç§åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¹¶ä¸å¸¸ç”¨ã€‚

## 4.2 CopyOnWriteArrayList

å®ƒç›¸å½“äºçº¿ç¨‹å®‰å…¨çš„ ArrayListã€‚å’Œ ArrayList ä¸€æ ·ï¼Œå®ƒæ˜¯ä¸ªå¯å˜æ•°ç»„ï¼›ä½†æ˜¯å’Œ ArrayList ä¸åŒçš„æ—¶ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. å®ƒæœ€é€‚åˆäºå…·æœ‰ä»¥ä¸‹ç‰¹å¾çš„åº”ç”¨ç¨‹åºï¼šList å¤§å°é€šå¸¸ä¿æŒå¾ˆå°ï¼Œåªè¯»æ“ä½œè¿œå¤š äºå¯å˜æ“ä½œï¼Œéœ€è¦åœ¨éå†æœŸé—´é˜²æ­¢çº¿ç¨‹é—´çš„å†²çªã€‚ 
2. å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 
3. å› ä¸ºé€šå¸¸éœ€è¦å¤åˆ¶æ•´ä¸ªåŸºç¡€æ•°ç»„ï¼Œæ‰€ä»¥å¯å˜æ“ä½œï¼ˆadd()ã€set() å’Œ remove()  ç­‰ç­‰ï¼‰çš„å¼€é”€å¾ˆå¤§ã€‚ 
4. è¿­ä»£å™¨æ”¯æŒ hasNext(), next()ç­‰ä¸å¯å˜æ“ä½œï¼Œä½†ä¸æ”¯æŒå¯å˜ remove()ç­‰æ“ä½œã€‚
5. ä½¿ç”¨è¿­ä»£å™¨è¿›è¡Œéå†çš„é€Ÿåº¦å¾ˆå¿«ï¼Œå¹¶ä¸”ä¸ä¼šä¸å…¶ä»–çº¿ç¨‹å‘ç”Ÿå†²çªã€‚åœ¨æ„é€ è¿­ä»£å™¨æ—¶ï¼Œè¿­ä»£å™¨ä¾èµ–äºä¸å˜çš„æ•°ç»„å¿«ç…§ã€‚

æœ€ä¸»è¦çš„ç‰¹ç‚¹ï¼š

- ç‹¬å é”æ•ˆç‡ä½ï¼šé‡‡ç”¨è¯»å†™åˆ†ç¦»æ€æƒ³è§£å†³
- å†™çº¿ç¨‹è·å–åˆ°é”ï¼Œå…¶ä»–å†™çº¿ç¨‹é˜»å¡ 

CopyOnWriteArrayList çš„ å¤åˆ¶æ€æƒ³ï¼š

å½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹ å™¨è¿›è¡Œ Copyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶åæ–°çš„å®¹å™¨é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´  ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚ 

è¿™æ—¶å€™ä¼šæŠ›å‡ºæ¥ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å¦‚æœå†™çº¿ç¨‹è¿˜æ²¡æ¥ å¾—åŠå†™ä¼šå†…å­˜ï¼Œå…¶ä»–çš„çº¿ç¨‹å°±ä¼šè¯»åˆ°äº†è„æ•°æ®ã€‚ ==è¿™å°±æ˜¯ CopyOnWriteArrayList çš„æ€æƒ³å’ŒåŸç†ã€‚å°±æ˜¯æ‹·è´ä¸€ä»½ã€‚==

```java
List<String> arrayList = new CopyOnWriteArrayList()
```

è¿™æ ·åˆ›å»ºä¹Ÿä¸ä¼šå‡ºç°çº¿ç¨‹å®‰è£…é—®é¢˜ã€‚

åŸå› åˆ†æ(é‡ç‚¹)ï¼š==åŠ¨æ€æ•°ç»„ä¸çº¿ç¨‹å®‰å…¨== ä¸‹é¢ä»â€œåŠ¨æ€æ•°ç»„â€å’Œâ€œçº¿ç¨‹å®‰å…¨â€ä¸¤ä¸ªæ–¹é¢è¿›ä¸€æ­¥å¯¹ CopyOnWriteArrayList çš„åŸç†è¿›è¡Œè¯´æ˜ã€‚

**åŠ¨æ€æ•°ç»„æœºåˆ¶** 

- å®ƒå†…éƒ¨æœ‰ä¸ªâ€œvolatile æ•°ç»„â€(array)æ¥ä¿æŒæ•°æ®ã€‚åœ¨â€œæ·»åŠ /ä¿®æ”¹/åˆ é™¤â€æ•°æ® æ—¶ï¼Œéƒ½ä¼šæ–°å»ºä¸€ä¸ªæ•°ç»„ï¼Œå¹¶å°†æ›´æ–°åçš„æ•°æ®æ‹·è´åˆ°æ–°å»ºçš„æ•°ç»„ä¸­ï¼Œæœ€åå†å°†è¯¥ æ•°ç»„èµ‹å€¼ç»™â€œvolatile æ•°ç»„â€, è¿™å°±æ˜¯å®ƒå«åš CopyOnWriteArrayList çš„åŸå›  
- ç”±äºå®ƒåœ¨â€œæ·»åŠ /ä¿®æ”¹/åˆ é™¤â€æ•°æ®æ—¶ï¼Œéƒ½ä¼šæ–°å»ºæ•°ç»„ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°ä¿®æ”¹æ•°æ®çš„ æ“ä½œï¼ŒCopyOnWriteArrayList æ•ˆç‡å¾ˆä½ï¼›ä½†æ˜¯å•å•åªæ˜¯è¿›è¡Œéå†æŸ¥æ‰¾çš„è¯ï¼Œ æ•ˆç‡æ¯”è¾ƒé«˜ã€‚ 

**çº¿ç¨‹å®‰å…¨æœºåˆ¶** 

- é€šè¿‡ volatile å’Œäº’æ–¥é”æ¥å®ç°çš„ã€‚ 
- é€šè¿‡â€œvolatile æ•°ç»„â€æ¥ä¿å­˜æ•°æ®çš„ã€‚ä¸€ä¸ªçº¿ç¨‹è¯»å– volatile æ•°ç»„æ—¶ï¼Œæ€»èƒ½çœ‹ åˆ°å…¶å®ƒçº¿ç¨‹å¯¹è¯¥ volatile å˜é‡æœ€åçš„å†™å…¥ï¼›å°±è¿™æ ·ï¼Œé€šè¿‡ volatile æä¾›äº†â€œè¯» å–åˆ°çš„æ•°æ®æ€»æ˜¯æœ€æ–°çš„â€è¿™ä¸ªæœºåˆ¶çš„ä¿è¯ã€‚ 
- é€šè¿‡äº’æ–¥é”æ¥ä¿æŠ¤æ•°æ®ã€‚åœ¨â€œæ·»åŠ /ä¿®æ”¹/åˆ é™¤â€æ•°æ®æ—¶ï¼Œä¼šå…ˆâ€œè·å–äº’æ–¥é”â€ï¼Œ å†ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œå…ˆå°†æ•°æ®æ›´æ–°åˆ°â€œvolatile æ•°ç»„â€ä¸­ï¼Œç„¶åå†â€œé‡Šæ”¾äº’æ–¥ é”â€ï¼Œå°±è¾¾åˆ°äº†ä¿æŠ¤æ•°æ®çš„ç›®çš„ã€‚

## 4.3 HashSetã€HashMapé›†åˆè§£å†³å¹¶å‘å¼‚å¸¸(çº¿ç¨‹ä¸å®‰å…¨)

### Seté›†åˆ

```java
Set<String> arrayList = new CopyOnWriteArraySet<String>();
```

### Mapé›†åˆ

```java
Map<String, String> hashMap = new ConcurrentHashMap<>();
```



## 4.4 å°ç»“

1. çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹ä¸å®‰å…¨é›†åˆ é›†åˆç±»å‹ä¸­å­˜åœ¨çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹ä¸å®‰å…¨çš„ä¸¤ç§,

   å¸¸è§ä¾‹å¦‚: ArrayList ----- Vector HashMap -----HashTable ä½†æ˜¯ä»¥ä¸Šéƒ½æ˜¯é€šè¿‡ synchronized å…³é”®å­—å®ç°,æ•ˆç‡è¾ƒä½ 

2. 2.Collections æ„å»ºçš„çº¿ç¨‹å®‰å…¨é›†åˆ 

3. java.util.concurrent å¹¶å‘åŒ…ä¸‹ CopyOnWriteArrayList CopyOnWriteArraySet ç±»å‹,é€šè¿‡åŠ¨æ€æ•°ç»„ä¸çº¿ç¨‹å®‰ å…¨ä¸ªæ–¹é¢ä¿è¯çº¿ç¨‹å®‰å…¨



# 5ã€å¤šçº¿ç¨‹é”

ä¸€ä¸ªå¯¹è±¡é‡Œé¢å¦‚æœæœ‰å¤šä¸ª synchronized æ–¹æ³•ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹å»è°ƒç”¨å…¶ä¸­çš„ ä¸€ä¸ª synchronized æ–¹æ³•ï¼Œ å…¶å®ƒçš„çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œæ¢å¥è¯è¯´ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªèƒ½æœ‰å”¯ä¸€ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®è¿™äº› synchronized æ–¹æ³•ã€‚

é”çš„æ˜¯å½“å‰å¯¹è±¡ thisï¼Œè¢«é”å®šåï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½ä¸èƒ½è¿›å…¥åˆ°å½“å‰å¯¹è±¡çš„å…¶å®ƒçš„ synchronized æ–¹æ³• 

åŠ ä¸ªæ™®é€šæ–¹æ³•åå‘ç°å’ŒåŒæ­¥é”æ— å…³ï¼Œæ¢æˆä¸¤ä¸ªå¯¹è±¡åï¼Œä¸æ˜¯åŒä¸€æŠŠé”äº†ï¼Œæƒ…å†µç«‹åˆ»å˜åŒ–ã€‚ 

synchronized å®ç°åŒæ­¥çš„åŸºç¡€ï¼šJava ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ã€‚ å…·ä½“è¡¨ç°ä¸ºä»¥ä¸‹ 3 ç§å½¢å¼ã€‚

1. å¯¹äºæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ã€‚ 
2. å¯¹äºé™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„ Class å¯¹è±¡ã€‚ 
3. å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯ Synchonized æ‹¬å·é‡Œé…ç½®çš„å¯¹è±¡ 

> å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”ã€‚ ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œè¯¥å®ä¾‹å¯¹è±¡çš„å…¶ä»–éé™æ€åŒæ­¥æ–¹ æ³•å¿…é¡»ç­‰å¾…è·å–é”çš„æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ï¼Œ å¯æ˜¯åˆ«çš„å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•å› ä¸ºè·Ÿè¯¥å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•ç”¨çš„æ˜¯ä¸åŒçš„é”ï¼Œ æ‰€ä»¥ä¸éœ€è¦ç­‰å¾…è¯¥å®ä¾‹å¯¹è±¡å·²è·å–åˆ°é”çš„éé™æ€åŒæ­¥æ–¹æ³•é‡Šæ”¾é”å°±å¯ä»¥è·å–ä»–ä»¬è‡ªå·±çš„é”ã€‚ 

æ‰€æœ‰çš„é™æ€åŒæ­¥æ–¹æ³•ç”¨çš„ä¹Ÿæ˜¯åŒä¸€æŠŠé”â€”â€”ç±»å¯¹è±¡æœ¬èº«ï¼Œè¿™ä¸¤æŠŠé”æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥é™æ€åŒæ­¥æ–¹æ³•ä¸éé™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´æ˜¯ä¸ä¼šæœ‰ç«æ€æ¡ä»¶çš„ã€‚ 

ä½†æ˜¯ä¸€æ—¦ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œå…¶ä»–çš„é™æ€åŒæ­¥æ–¹æ³•éƒ½å¿…é¡»ç­‰å¾…è¯¥æ–¹æ³•é‡Šæ”¾é”åæ‰ èƒ½è·å–é”ï¼Œè€Œä¸ç®¡æ˜¯åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œè¿˜æ˜¯ä¸åŒçš„å®ä¾‹å¯¹è±¡çš„é™æ€åŒ æ­¥æ–¹æ³•ä¹‹é—´ï¼Œåªè¦å®ƒä»¬åŒä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ï¼

## 5.1 å…¬å¹³é”å’Œéå…¬å¹³é”

æºç ï¼š

```java
/**
 * Creates an instance of {@code ReentrantLock}.
 * This is equivalent to using {@code ReentrantLock(false)}.
 */
public ReentrantLock() {
    sync = new NonfairSync();
}

/**
 * Creates an instance of {@code ReentrantLock} with the
 * given fairness policy.
 *
 * @param fair {@code true} if this lock should use a fair ordering policy
 */
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

### 5.1.1 éå…¬å¹³é”

éå…¬å¹³é”æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å°†ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå¯¼è‡´å…¶ä»–çš„çº¿ç¨‹å¤„äºä¸€ä¸ªé¥¿æ­»çš„çŠ¶æ€ã€‚

ç¼ºç‚¹ï¼š

- å¯¼è‡´çº¿ç¨‹é¥¿æ­»

ä¼˜ç‚¹ï¼š

- æ•ˆç‡é«˜

### 5.1.2 éå…¬å¹³é”

å…¬å¹³é”æ˜¯æŒ‡æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½èƒ½å¾—åˆ°ä»»åŠ¡æ‰§è¡Œï¼Œä¸ä¼šå¯¼è‡´å…¶ä»–çš„çº¿ç¨‹å¤„äºä¸€ä¸ªé¥¿æ­»çš„çŠ¶æ€ã€‚

ç¼ºç‚¹ï¼š

- æ•ˆç‡è¾ƒä½

ä¼˜ç‚¹ï¼š

- çº¿ç¨‹ä¸ä¼šå‡ºç°é¥¿æ­»

## 5.2 å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰

synchronizationï¼ˆéšå¼é”ï¼‰ã€lockï¼ˆæ˜¾ç¤ºé”ï¼‰

> ç›¸å½“äºå›å®¶å¼€é—¨ï¼Œä¹Ÿå°±æ˜¯ä½ åªè¦æ‰“å¼€äº†å¤§é—¨çš„é”ï¼Œå°±å¯ä»¥è‡ªç”±çš„ï¼ˆæ— éšœç¢ï¼‰è¿›å…¥é‡Œé¢çš„ä»»ä½•ä¸€ä¸ªé—¨ï¼ˆé”ï¼‰

```
public class EnableInLock {
    public static void main(String[] args) {
        // synchronization å¯é‡å…¥é”
        Object o = new Object();
        new Thread(()->{
            synchronized (o) {
                System.out.println("å¤–å±‚");
                synchronized (o) {
                    System.out.println("ä¸­å±‚");
                    synchronized (o) {
                        System.out.println("å†…å±‚");
                    }
                }
            }
        }).start();
    }
}
```

### Lock å¯é‡å…¥é”

> ä¸Šé”å’Œé‡Šæ”¾é”éƒ½å¿…é¡»ä¸»åŠ¨å®Œæˆï¼Œä¸èƒ½ç¼ºå°‘é‡Šæ”¾é”

```java
// lock å¯é‡å…¥é”
ReentrantLock lock = new ReentrantLock();
new Thread(() -> {
    lock.lock();
    try {
        System.out.println("lockå¯é‡å…¥é”å¤–å±‚");
        lock.lock();
        try {
            System.out.println("lockå¯é‡å…¥é”å†…å±‚");
        }finally {
            lock.unlock();
        }
    }finally {
        lock.unlock();
    }
}).start();
```

## 5.3 æ­»é”

æ­»é”ï¼šä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºäº‰å¤ºèµ„æºè€Œé€ æˆä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œå¦‚æœæ²¡æœ‰å¤–åŠ›å¹²æ¶‰ï¼Œä»–ä»¬å°†ä¸€è‡´å¤„äºæ­»é”çŠ¶æ€ã€‚

![image-20230221202424508](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230221202424508.png)



äº§ç”Ÿæ­»é”çš„åŸå› ï¼š

1. ç³»ç»Ÿèµ„æºä¸è¶³
2. è¿›ç¨‹è¿è¡Œé¡ºåºä¸åˆé€‚
3. èµ„æºåˆ†é…ä¸å½“

```java
/**
 * @author Shier 2023/2/21 20:27
 */
public class DeadLock {
    public static void main(String[] args) {
        Object a = new Object();
        Object b = new Object();
        new Thread(() -> {
            synchronized (a) {
                System.out.println(Thread.currentThread().getName() + "è¯•å›¾è·å–é”b");
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (b) {
                    System.out.println(Thread.currentThread().getName() + "aè·å–åˆ°é”b");
                }
            }
        }).start();
        new Thread(() -> {
            synchronized (b) {
                System.out.println(Thread.currentThread().getName() + "è¯•å›¾è·å–é”a");
                System.out.println(Thread.currentThread().getName() + "è¯•å›¾è·å–é”b");
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (a) {
                    System.out.println(Thread.currentThread().getName() + "bè·å–åˆ°é”a");
                }
            }
        }).start();
    }
}
```

éªŒè¯æ­»é”

1. jps -l ï¼šæŸ¥çœ‹å½“å‰è¿›ç¨‹

   ![image-20230221203910392](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230221203910392.png)

2. jstack è¿›ç¨‹å· 

![image-20230221203927604](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230221203927604.png)











# 6ã€callable æ¥å£

ç›®å‰æˆ‘ä»¬å­¦ä¹ äº†æœ‰ä¸¤ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•-ä¸€ç§æ˜¯é€šè¿‡åˆ›å»º Thread ç±»ï¼Œå¦ä¸€ç§æ˜¯ é€šè¿‡ä½¿ç”¨ Runnable åˆ›å»ºçº¿ç¨‹ã€‚ä½†æ˜¯ï¼ŒRunnable ç¼ºå°‘çš„ä¸€é¡¹åŠŸèƒ½æ˜¯ï¼Œå½“çº¿ç¨‹ç»ˆæ­¢æ—¶ï¼ˆå³ runï¼ˆï¼‰æ–¹æ³•å®Œæˆæ—¶ï¼‰ï¼Œæˆ‘ä»¬æ— æ³•ä½¿çº¿ç¨‹è¿”å›ç»“æœã€‚ä¸ºäº†æ”¯æŒæ­¤åŠŸèƒ½ï¼Œ Java ä¸­æä¾›äº† Callable æ¥å£ã€‚



## 6.1 åˆ›å»ºçº¿ç¨‹çš„ç¬¬ä¸‰ç§æ–¹æ¡ˆ---Callable æ¥å£

Callable æ¥å£ç‰¹ç‚¹ï¼š

- ä¸ºäº†å®ç° Runnableï¼Œéœ€è¦å®ç°ä¸è¿”å›ä»»ä½•å†…å®¹çš„ run())æ–¹æ³•ï¼Œè€Œå¯¹äº Callableï¼Œéœ€è¦å®ç°åœ¨å®Œæˆæ—¶è¿”å›ç»“æœçš„ cal()æ–¹æ³•ã€‚ â€¢
- call() æ–¹æ³•å¯ä»¥å¼•å‘å¼‚å¸¸ï¼Œè€Œ run() åˆ™ä¸èƒ½ã€‚ 
- ä¸ºå®ç° Callable è€Œå¿…é¡»é‡å†™ call()æ–¹æ³• 
- ä¸èƒ½ç›´æ¥æ›¿æ¢ runnableï¼Œå› ä¸º Thread ç±»çš„æ„é€ æ–¹æ³•æ ¹æœ¬æ²¡æœ‰ Callable



## 6.2 Future æ¥å£

å½“ call() æ–¹æ³•å®Œæˆæ—¶ï¼Œç»“æœå¿…é¡»å­˜å‚¨åœ¨ä¸»çº¿ç¨‹å·²çŸ¥çš„å¯¹è±¡ä¸­ï¼Œä»¥ä¾¿ä¸»çº¿ç¨‹å¯ ä»¥çŸ¥é“è¯¥çº¿ç¨‹è¿”å›çš„ç»“æœã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ Future å¯¹è±¡ã€‚

å°† Future è§†ä¸ºä¿å­˜ç»“æœçš„å¯¹è±¡ï¼Œå®ƒå¯èƒ½æš‚æ—¶ä¸ä¿å­˜ç»“æœï¼Œä¸€æ—¦Callable è¿”å›å°†ä¼šè¿›è¡Œä¿å­˜ã€‚Future åŸºæœ¬ä¸Šæ˜¯==ä¸»çº¿ç¨‹å¯ä»¥è·Ÿè¸ªè¿›åº¦ä»¥åŠå¾—åˆ°å…¶ä»–çº¿ç¨‹çš„ç»“æœçš„==ä¸€ç§æ–¹å¼ã€‚è¦å®ç°æ­¤æ¥å£ï¼Œå¿…é¡»é‡å†™ 5 ç§æ–¹æ³•ï¼Œè¿™é‡Œåˆ—å‡ºäº†é‡è¦çš„æ–¹æ³•ï¼Œå¦‚ä¸‹:

1. public boolean cancelï¼ˆboolean mayInterruptï¼‰ï¼šç”¨äºåœæ­¢ä»»åŠ¡ã€‚å¦‚æœå°šæœªå¯åŠ¨ï¼Œå®ƒå°†åœæ­¢ä»»åŠ¡ã€‚å¦‚æœå·²å¯åŠ¨ï¼Œåˆ™ä»…åœ¨ mayInterrupt ä¸º true æ—¶æ‰ä¼šä¸­æ–­ä»»åŠ¡ã€‚
2. public Object get() æŠ›å‡º InterruptedExceptionï¼ŒExecutionExceptionï¼š ç”¨äºè·å–ä»»åŠ¡çš„ç»“æœã€‚å¦‚æœä»»åŠ¡å®Œæˆï¼Œå®ƒå°†ç«‹å³è¿”å›ç»“æœï¼Œå¦åˆ™å°†ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œç„¶åè¿”å›ç»“æœã€‚
3. public boolean isDone() ï¼šå¦‚æœä»»åŠ¡å®Œæˆï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false

å¯ä»¥çœ‹åˆ° Callable å’Œ Future åšä¸¤ä»¶äº‹ï¼ŒCallable ä¸ Runnable ç±»ä¼¼ï¼Œå› ä¸ºå®ƒå°è£…äº†è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œ Future ç”¨äºå­˜å‚¨ä»å¦ä¸€ä¸ªçº¿ç¨‹è·å¾—çš„ç»“æœã€‚å®é™…ä¸Šï¼Œfuture ä¹Ÿå¯ä»¥ä¸ Runnable ä¸€èµ·ä½¿ç”¨ã€‚

## 6.3 FutureTask  

Java åº“å…·æœ‰å…·ä½“çš„ FutureTask ç±»å‹ï¼Œè¯¥ç±»å‹å®ç° Runnable å’Œ Futureï¼Œå¹¶æ–¹ä¾¿åœ°å°†ä¸¤ç§åŠŸèƒ½ç»„åˆåœ¨ä¸€èµ·ã€‚ å¯ä»¥é€šè¿‡ä¸ºå…¶æ„é€ å‡½æ•°æä¾› Callable æ¥åˆ›å»º FutureTaskã€‚ç„¶åï¼Œå°† FutureTask å¯¹è±¡æä¾›ç»™ Thread çš„æ„é€ å‡½æ•°ä»¥åˆ›å»º Thread å¯¹è±¡ã€‚å› æ­¤ï¼Œé—´æ¥åœ°ä½¿ç”¨ Callable åˆ›å»ºçº¿ç¨‹ã€‚

### æ ¸å¿ƒåŸç†:(é‡ç‚¹)

1. åœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦æ‰§è¡Œæ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ—¶ï¼Œä½†åˆä¸æƒ³é˜»å¡ä¸»çº¿ç¨‹æ—¶ï¼Œå¯ä»¥æŠŠè¿™äº›ä»»åŠ¡äº¤ç»™ Future å¯¹è±¡åœ¨åå°å®Œæˆï¼Œ
2. å½“ä¸»çº¿ç¨‹å°†æ¥éœ€è¦æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ Future å¯¹è±¡è·å¾—åå°ä»»åŠ¡çš„è®¡ç®—ç»“æœæˆ–è€…æ‰§è¡ŒçŠ¶æ€ï¼Œ
3. ä¸€èˆ¬ FutureTask å¤šç”¨äºè€—æ—¶çš„è®¡ç®—ï¼Œä¸»çº¿ç¨‹å¯ä»¥åœ¨å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œå†å»è·å–ç»“æœï¼Œ 
4. ä»…åœ¨è®¡ç®—å®Œæˆæ—¶æ‰èƒ½æ£€ç´¢ç»“æœï¼›å¦‚æœè®¡ç®—å°šæœªå®Œæˆï¼Œåˆ™é˜»å¡ get æ–¹æ³•ï¼Œä¸€æ—¦è®¡ç®—å®Œæˆï¼Œå°±ä¸èƒ½å†é‡æ–°å¼€å§‹æˆ–å–æ¶ˆè®¡ç®— ï¼Œ
5. get æ–¹æ³•è·å–ç»“æœåªæœ‰åœ¨è®¡ç®—å®Œæˆæ—¶è·å–ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ä»»åŠ¡è½¬å…¥å®ŒæˆçŠ¶æ€ï¼Œç„¶åä¼šè¿”å›ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸ ï¼Œ
6. get åªè®¡ç®—ä¸€æ¬¡ï¼Œå› æ­¤ get æ–¹æ³•æ”¾åˆ°æœ€åã€‚

ä¾‹å­è¯´æ˜ï¼š

1. æˆ‘åœ¨æ•²ä»£ç ï¼Œçªç„¶å£æ¸´äº†ï¼Œå‡ºå»ä¹°æ°´ä¸å¤ªåˆé€‚ï¼ˆæ‰“æ–­æ€è·¯ï¼‰ï¼Œæˆ‘è¦ç»§ç»­æ•²ä»£ç ï¼Œåªèƒ½å•ç‹¬çš„å«ä¸€ä¸ªäººå»å¸®æˆ‘ä¹°æ°´å›æ¥ï¼Œç„¶åæ”¾åˆ°æˆ‘çš„æ¡Œå­ä¸Šï¼Œæˆ‘å°±å¯ä»¥ç›´æ¥å–ã€‚ï¼ˆä¸å½±å“ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå•ç‹¬å¼€å¯ä¸€ä¸ªå•çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼‰
2. æˆ‘å£æ¸´äº†ï¼Œå«äººå»ä¹°æ°´ï¼Œä½†æ˜¯ä»–ç¬¬ä¸€æ¬¡ä¹°çš„æ°´ä¸æ˜¯æˆ‘æƒ³å–çš„ï¼Œåé¢ä»–åˆåœ¨å»ä¸€è¶Ÿä¹°æ°´ï¼Œä¹°äº†å‡ è¶Ÿæ‰ä¹°åˆ°æƒ³å–çš„æ°´ï¼Œå¦‚æœæˆ‘ä¸‹æ¬¡è¿˜å«ä»–å»å¸®å¿™ä¹°æ°´ï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥ç›´æ¥ä¹°æˆ‘å–œæ¬¢å–çš„å°±å¯ä»¥äº†ï¼Œä¸ç”¨å†æŠ˜è…¾é‚£ä¹ˆå¤šæ¬¡ã€‚ï¼ˆä¹Ÿå°±æ˜¯æ±‡æ€»ä¸€æ¬¡ï¼Œè®¡ç®—ä¸€æ¬¡ï¼‰

```java
// Runnable åˆ›å»ºçº¿ç¨‹
class RunnableThread implements Runnable {
    @Override
    public void run() {
    }
}
// Callable æ¥å£ , æœ‰è¿”å›å€¼
class CallableThread implements Callable {
    @Override
    public Integer call() throws Exception {
        System.out.println(Thread.currentThread().getName() + "è¿›å…¥callable");
        return 2222;
    }
}
public class CallableDemo {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        // Runnable åˆ›å»ºçº¿ç¨‹
        new Thread(new RunnableThread(), "Runnableåˆ›å»ºçº¿ç¨‹").start();
        // Callable æ¥å£åˆ›å»ºçº¿ç¨‹, FutureTaskæœªæ¥ä»»åŠ¡
        FutureTask<Integer> futureTask = new FutureTask<>(new CallableThread());
        // ç®€åŒ–å†™æ³•ï¼ŒFutureTaskæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£çš„ç±»
        FutureTask<Integer> ft = new FutureTask<>(() -> {
            System.out.println(Thread.currentThread().getName() + "è¿›å…¥callable");
            return 1024;
        });
        // åˆ›å»ºçº¿ç¨‹
        new Thread(ft, "ft").start();
        new Thread(futureTask, "futureTask").start();
        // æ²¡æœ‰è®¡ç®—å®Œæˆå°±ä¸€ç›´ç­‰å¾…
        while (!ft.isDone()) {
            System.out.println("è¿˜åœ¨è®¡ç®—.....");
        }
        // è®¡ç®—å®Œæˆåˆ™ä¼šè¿›è¡Œæ±‡æ€» getåˆ°ç»“æœ
        System.out.println(ft.get()); // 1024
        System.out.println(futureTask.get()); // 2222
        System.out.println(Thread.currentThread().getName() + "ç»“æŸ"); // mainçº¿ç¨‹ç»“æŸ
    }
}
```



# 7ã€JUCä¸‰å¤§è¾…åŠ©ç±»

JUC ä¸­æä¾›äº†ä¸‰ç§å¸¸ç”¨çš„è¾…åŠ©ç±»ï¼Œé€šè¿‡è¿™äº›è¾…åŠ©ç±»å¯ä»¥å¾ˆå¥½çš„è§£å†³çº¿ç¨‹æ•°é‡è¿‡ å¤šæ—¶ Lock é”çš„é¢‘ç¹æ“ä½œã€‚è¿™ä¸‰ç§è¾…åŠ©ç±»ä¸ºï¼š

1. `CountDownLatch`: å‡å°‘è®¡æ•°
2. `CyclicBarrier`: å¾ªç¯æ …æ 
3. `Semaphore`: ä¿¡å·ç¯



## 7.1 å‡å°‘è®¡æ•° CountDownLatch

CountDownLatch ç±»å¯ä»¥è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åé€šè¿‡ countDown æ–¹æ³•æ¥è¿›è¡Œå‡ 1 çš„æ“ä½œï¼Œä½¿ç”¨ await æ–¹æ³•ç­‰å¾…è®¡æ•°å™¨ä¸å¤§äº 0ï¼Œç„¶åç»§ç»­æ‰§è¡Œ await æ–¹æ³•ä¹‹åçš„è¯­å¥ã€‚

- CountDownLatch ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•æ—¶ï¼Œè¿™äº›çº¿ç¨‹ä¼šé˜»å¡
- å…¶å®ƒçº¿ç¨‹è°ƒç”¨ countDown æ–¹æ³•ä¼šå°†è®¡æ•°å™¨å‡ 1(è°ƒç”¨ countDown æ–¹æ³•çš„çº¿ç¨‹ä¸ä¼šé˜»å¡)
- å½“è®¡æ•°å™¨çš„å€¼å˜ä¸º 0 æ—¶ï¼Œå›  await æ–¹æ³•é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œ

å®é™…ä¾‹å­è¯´æ˜ï¼š

-  6 ä¸ªåŒå­¦é™†ç»­ç¦»å¼€æ•™å®¤åå€¼ç­åŒå­¦æ‰å¯ä»¥å…³é—¨ã€‚

```java
/**
 * @author Shier 2023/2/21 22:11
 * æ¨¡æ‹Ÿæ•™å®¤äººèµ°å®Œå…³ç¯æ•ˆæœ
 */
public class CountDownLatchDemo {
    public static void main(String[] args) {
        // æ€»å…±10ä¸ªäººï¼Œèµ°å®Œäº†æ‰å¯ä»¥å…³ç¯
        // ä½¿ç”¨CountDownLatch è¿›è¡Œåˆå§‹åŒ–æ•°æ®
        CountDownLatch countDownLatch = new CountDownLatch(10);
        for (int i = 10; i > 0; i--) {
            // åˆ›å»ºçº¿ç¨‹
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName() + "å­¦å·å­¦ç”Ÿç¦»å¼€æ•™å®¤");
                // è®¡æ•°å‡ä¸€
                countDownLatch.countDown();
            }, String.valueOf(i)).start();
        }
        // å¦‚æœè¿˜æ²¡æœ‰ä¸º0 åˆ™ä¼šä¸€ç›´ç­‰å¾…
        try {
            countDownLatch.await();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.currentThread().getName() + "å…³é—¨èµ°äººäº†...");
    }
}
```



## 7.2 å¾ªç¯æ …æ  CyclicBarrier

ä½¿ç”¨ä¸­ CyclicBarrier çš„æ„é€ æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡éšœç¢æ•°ï¼Œæ¯æ¬¡æ‰§è¡Œ CyclicBarrier ä¸€æ¬¡éšœç¢æ•°ä¼šåŠ ä¸€ï¼Œå¦‚æœè¾¾åˆ°äº†ç›®æ ‡éšœç¢æ•°ï¼Œæ‰ä¼šæ‰§è¡Œ cyclicBarrier.await()ä¹‹å çš„è¯­å¥ã€‚å¯ä»¥å°† CyclicBarrier ç†è§£ä¸ºåŠ  1 æ“ä½œ

ä¾‹å­ï¼š

- æ”¶é›†ä¸ƒé¢—é¾™ç å¬å”¤ç¥é¾™è®¸æ„¿

```java
/**
 * @author Shier 2023/2/21 22:30
 */
public class CyclicBarrierDemo {
    // åˆ›å»ºç›®æ ‡åˆ°è¾¾çš„å€¼
    private static final int NUMBER = 7;

    public static void main(String[] args) {
        // åˆ›å»ºCyclicBarrierå¯¹è±¡
        CyclicBarrier cyclicBarrier = new CyclicBarrier(NUMBER, (() -> {
            System.out.println("é›†é½å®Œæ¯•ï¼Œå¼€å§‹è®¸æ„¿ï¼Œç¥ä½ æ„¿æœ›æˆçœŸï¼");
        }));
        // åˆ›å»ºçº¿ç¨‹
        for (int i = 1; i <= 7; i++) {
            new Thread(() -> {
                try {
                    System.out.println(Thread.currentThread().getName() + "æ˜Ÿç åˆ°æ‰‹ï¼");
                    // å¦åˆ™ç­‰å¾…
                    cyclicBarrier.await();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }, String.valueOf(i)).start();
        }
    }
}
```

## 7.3 ä¿¡å·ç¯ Semaphore

Semaphore çš„æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€å¤§ä¿¡å·é‡ï¼ˆå¯ä»¥çœ‹æˆæœ€å¤§çº¿ ç¨‹æ± ï¼‰ï¼Œæ¯ä¸ªä¿¡å·é‡åˆå§‹åŒ–ä¸ºä¸€ä¸ªæœ€å¤šåªèƒ½åˆ†å‘ä¸€ä¸ªè®¸å¯è¯ã€‚ä½¿ç”¨ acquire æ–¹æ³•è·å¾—è®¸å¯è¯ï¼Œè·å¾—è®¸å¯ä¹‹åå…¶ä»–çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œrelease æ–¹æ³•é‡Šæ”¾è®¸å¯ï¼Œå…¶ä»–çº¿ç¨‹æ–¹å¯è·å¾—è®¸å¯è¯ã€‚

åœºæ™¯: æŠ¢è½¦ä½, 6 éƒ¨æ±½è½¦ 3 ä¸ªåœè½¦ä½

```java
package com.shier.jucauxiliary;

import javax.swing.plaf.TableHeaderUI;
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;

/**
 * @author Shier 2023/2/21 22:45
 * 6 éƒ¨æ±½è½¦ 3 ä¸ªåœè½¦ä½
 */
public class SemaphoreDemo {
    public static void main(String[] args) {
        // åˆ›å»ºSemaphore è®¾ç½®è®¸å¯çš„æ•°é‡
        Semaphore semaphore = new Semaphore(3);

        // å¾ªç¯å…­æ¬¡ï¼Œåˆ›å»ºå…­ä¸ªçº¿ç¨‹
        for (int i = 1; i <= 6; i++) {
            new Thread(() -> {
                // è·å¾—è®¸å¯
                try {
                    semaphore.acquire();
                    System.out.println("-------" + Thread.currentThread().getName() + "å·è½¦å¯»æ‰¾è½¦ä½ingã€‚");
                    // è®¾ç½®ä¸€ä¸ªéšæœºæ—¶é—´æ¥å ç”¨è½¦ä½
                    Thread.sleep(2000);
                    System.out.println(Thread.currentThread().getName() + "å·è½¦è·å¾—è½¦ä½ã€‚");
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    // é‡Šæ”¾è®¸å¯
                    System.out.println("*******" + Thread.currentThread().getName() + "å·è½¦ç¦»å¼€è½¦ä½ã€‚");
                    semaphore.release();
                }
            }, String.valueOf(i)).start();
        }
    }
}
```





# 8ã€è¯»å†™é”  

## 8.1 è¯»å†™é”ä»‹ç»  

> ç°å®ä¸­æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼šå¯¹å…±äº«èµ„æºæœ‰è¯»å’Œå†™çš„æ“ä½œï¼Œä¸”å†™æ“ä½œæ²¡æœ‰è¯»æ“ä½œé‚£ä¹ˆé¢‘ç¹ã€‚åœ¨æ²¡æœ‰å†™æ“ä½œçš„æ—¶å€™ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥åº”è¯¥å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å…±äº«èµ„æºï¼›ä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™è¿™äº›å…±äº«èµ„æºï¼Œ å°±ä¸åº”è¯¥å…è®¸å…¶ä»–çº¿ç¨‹å¯¹è¯¥èµ„æºè¿›è¡Œè¯»å’Œå†™çš„æ“ä½œäº†ã€‚

é’ˆå¯¹è¿™ç§åœºæ™¯ï¼ŒJAVA çš„å¹¶å‘åŒ…æä¾›äº†è¯»å†™é” ReentrantReadWriteLockï¼Œ å®ƒè¡¨ç¤ºä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯è¯»æ“ä½œç›¸å…³çš„é”ï¼Œç§°ä¸ºå…±äº«é”ï¼›ä¸€ä¸ªæ˜¯å†™ç›¸å…³çš„é”ï¼Œç§°ä¸ºæ’ä»–é”

çº¿ç¨‹è¿›å…¥å†™é”çš„å‰ææ¡ä»¶ï¼š

1. æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„è¯»é” 
2. æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™é” 

è€Œè¯»å†™é”æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ç‰¹æ€§ï¼š 

ï¼ˆ1ï¼‰å…¬å¹³é€‰æ‹©æ€§ï¼šæ”¯æŒéå…¬å¹³ï¼ˆé»˜è®¤ï¼‰å’Œå…¬å¹³çš„é”è·å–æ–¹å¼ï¼Œååé‡è¿˜æ˜¯éå…¬ å¹³ä¼˜äºå…¬å¹³ã€‚ 

ï¼ˆ2ï¼‰é‡è¿›å…¥ï¼šè¯»é”å’Œå†™é”éƒ½æ”¯æŒçº¿ç¨‹é‡è¿›å…¥ã€‚ 

ï¼ˆ3ï¼‰é”é™çº§ï¼šéµå¾ªè·å–å†™é”ã€è·å–è¯»é”å†é‡Šæ”¾å†™é”çš„æ¬¡åºï¼Œå†™é”èƒ½å¤Ÿé™çº§æˆä¸º è¯»é”ã€‚

### 8.1.1 è¯»é”å‘ç”Ÿæ­»é”

![image-20230222101944989](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222101944989.png)



### 8.1.2 å†™é”å‘ç”Ÿæ­»é”

å½“çº¿ç¨‹1 åœ¨å¯¹ç¬¬ä¸€ä¸ªè¿›è¡Œå†™æ“ä½œï¼Œçº¿ç¨‹2å¯¹ç¬¬äºŒä¸ªè¿›è¡Œå†™æ“ä½œï¼Œç”±äºæ˜¯å¯ä»¥å¹¶å‘æ“ä½œçš„ï¼Œæ‰€ä»¥å½“çº¿ç¨‹1æˆ–è€…çº¿ç¨‹2å¯¹å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨å†™æ“ä½œçš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶éœ€è¦ç­‰å¾…å¯¹æ–¹å†™æ“ä½œå®Œæˆæ‰å¯ä»¥è¿›è¡Œï¼Œæ­¤æ—¶å°±æœ‰å¯èƒ½ä¼šå‡ºç°äº’ç›¸æ“ä½œå¯¹æ–¹çš„å†™æ“ä½œè¿›è€Œå‡ºç°æ­»é”ã€‚

![image-20230222102149497](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222102149497.png)

#### é”çš„æ¯”è¾ƒ

![image-20230222110348300](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222110348300.png)

è¯»å†™é”çš„æ¡ˆä¾‹å®ç°ï¼š

```java
/**
 * @author Shier 2023/2/22 10:27
 */
class CacheDemo {

    // åˆ›å»ºä¸€ä¸ªmapé›†åˆ volatileè¡¨ç¤ºä¸æ–­å˜åŒ–
    private volatile Map<String, Object> map = new HashMap<>();
    // åˆ›å»ºä¸€ä¸ªè¯»å†™é”
    private ReadWriteLock readWriteLock = new ReentrantReadWriteLock();

    // å†™å…¥è¿‡ç¨‹
    public void writeMethod(String key, Object value) {
        // å†™é”ä¸Šé”
        readWriteLock.writeLock().lock();
        try {
            System.out.println(Thread.currentThread().getName() + "æ­£åœ¨å†™å…¥å†…å®¹" + key);
            TimeUnit.MICROSECONDS.sleep(300);
            // å†™å…¥å†…å®¹
            map.put(key, value);
            System.out.println(Thread.currentThread().getName() + "å†™å…¥å®Œæˆ" + key);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // é‡Šæ”¾é”
            readWriteLock.writeLock().unlock();
        }
    }

    // è¯»å–è¿‡ç¨‹
    public Object readMethod(String key) {

        // è¯»é”ä¸Šé”
        readWriteLock.readLock().lock();
        Object result = null;
        try {
            System.out.println(Thread.currentThread().getName() + "æ­£åœ¨è¯»å–å†…å®¹" + key);
            TimeUnit.MICROSECONDS.sleep(300);
            // è¯»å–å†…å®¹
            result = map.get(key);
            System.out.println(Thread.currentThread().getName() + "è¯»å–åˆ°äº†" + key);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // é‡Šæ”¾é”
            readWriteLock.readLock().unlock();
        }
        return result;
    }
}

public class ReadWriteLockDemo {
    public static void main(String[] args) {
        CacheDemo cacheDemo = new CacheDemo();
        // å†™
        for (int i = 1; i <= 10; i++) {
            final int number = i;
            new Thread(() -> {
                cacheDemo.writeMethod(String.valueOf(number), number);
            },String.valueOf(i)).start();
        }
        // è¯»
        for (int i = 1; i <= 10; i++) {
            final int number = i;
            new Thread(() -> {
                cacheDemo.readMethod(String.valueOf(number));
            },String.valueOf(i)).start();
        }
    }
}
```



### 8.1.3 è¯»å†™é”é™çº§

é”é™çº§æ˜¯æŒ‡å°†å½“å‰æŒæœ‰çš„é”ä»é«˜çº§åˆ«é”é™ä¸ºä½çº§åˆ«é”çš„è¿‡ç¨‹ã€‚åœ¨å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„åœºæ™¯ä¸­ï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¼šåœ¨ä¸šåŠ¡å¤„ç†çš„è¿‡ç¨‹ä¸­åŠ é”ï¼Œä¸ºäº†é¿å…æ­»é”ã€æ€§èƒ½é—®é¢˜ç­‰é—®é¢˜ï¼Œæœ‰æ—¶å€™éœ€è¦åœ¨ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¿›è¡Œé”é™çº§ã€‚

é”é™çº§çš„ä¸»è¦ç›®çš„æ˜¯==ä¸ºäº†åœ¨æŒæœ‰é«˜çº§åˆ«é”çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œéœ€è¦æŒæœ‰ä½çº§åˆ«é”æ‰èƒ½è¿›è¡Œçš„æ“ä½œï¼Œè€Œä¸éœ€è¦é‡Šæ”¾é«˜çº§åˆ«é”å†é‡æ–°è·å–ä½çº§åˆ«é”çš„æ“ä½œ==ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€æ®µä»£ç ä¸­æŒæœ‰äº†æ•°æ®åº“çš„è¡Œçº§é”ï¼Œä¸ºäº†æ‰§è¡ŒæŸäº›æ“ä½œéœ€è¦è¿›è¡Œè¡¨çº§é”çš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡é”é™çº§å°†è¡Œçº§é”é™ä¸ºè¡¨çº§é”ã€‚

é”é™çº§çš„æ“ä½œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. è·å–é«˜çº§åˆ«é”ï¼›
2. æ‰§è¡Œéœ€è¦é«˜çº§åˆ«é”æ‰èƒ½æ‰§è¡Œçš„æ“ä½œï¼›
3. è·å–ä½çº§åˆ«é”ï¼›
4. é‡Šæ”¾é«˜çº§åˆ«é”ã€‚
5. ä½¿ç”¨ä½çº§åˆ«é”

åœ¨æ‰§è¡Œé”é™çº§çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¿è¯é«˜çº§åˆ«é”å’Œä½çº§åˆ«é”çš„é¡ºåºï¼Œå…ˆè·å–é«˜çº§åˆ«é”å†è·å–ä½çº§åˆ«é”ï¼ŒåŒæ—¶åœ¨é‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦æŒ‰ç…§ç›¸åçš„é¡ºåºè¿›è¡Œé‡Šæ”¾ã€‚å¦‚æœé¡ºåºä¸æ­£ç¡®ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ­»é”ç­‰é—®é¢˜ã€‚

æ€»çš„æ¥è¯´ï¼Œé”é™çº§å¯ä»¥é¿å…åœ¨æ‰§è¡Œä»£ç çš„è¿‡ç¨‹ä¸­é¢‘ç¹åœ°è·å–å’Œé‡Šæ”¾é”ï¼Œæé«˜å¹¶å‘æ€§èƒ½å’Œé™ä½æ­»é”ç­‰é—®é¢˜çš„å‘ç”Ÿã€‚ä½†æ˜¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œè¯„ä¼°å’Œé€‰æ‹©ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨é”é™çº§å¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤ã€‚

å¤§è‡´çš„æµç¨‹ï¼š



~~~mermaid
graph LR
a(è·å–å†™é”)-->b(è·å–è¯»é”)-->c(é‡Šæ”¾å†™é”)-->d(é‡Šæ”¾è¯»é”)
~~~

å†™é”çš„æƒé™å¤§äºè¯»é”çš„æƒé™ã€‚

```java
public class LowerLockDemo {
    public static void main(String[] args) {
        // åˆ›å»ºå¯é‡å…¥é”å¯¹è±¡
        ReentrantReadWriteLock readWriteLock = new ReentrantReadWriteLock();
        // å†™é”
        ReentrantReadWriteLock.WriteLock writeLock = readWriteLock.writeLock();
        // è¯»é”
        ReentrantReadWriteLock.ReadLock readLock = readWriteLock.readLock();
        // ä¸€èˆ¬æ¥è¯´å†™é”å¤§äºè¯»é”
        // 1.è·å–é«˜çº§é”-å†™é”
        writeLock.lock();
        System.out.println("é«˜çº§é”-å†™é”");
        // 2.è·å–ä½çº§é”-è¯»é”
        readLock.lock();
        System.out.println("ä½çº§é”-è¯»é”");
        // 3. é‡Šæ”¾é«˜çº§é”
        writeLock.unlock();
        // 4. é‡Šæ”¾ä½çº§é”
        readLock.unlock();
    }
}
```

- è¯»é”ä¸èƒ½å‡çº§ä¸ºå†™é”
- ä¹Ÿå°±æ˜¯ä½çº§é”ä¸èƒ½å‡çº§ä¸ºé«˜çº§æ‰€

åŸå› : å½“çº¿ç¨‹è·å–è¯»é”çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹åŒæ—¶ä¹Ÿåœ¨æŒæœ‰è¯»é”ï¼Œå› æ­¤ä¸èƒ½æŠŠ è·å–è¯»é”çš„çº¿ç¨‹â€œå‡çº§â€ä¸ºå†™é”ï¼›è€Œå¯¹äºè·å¾—å†™é”çš„çº¿ç¨‹ï¼Œå®ƒä¸€å®šç‹¬å äº†è¯»å†™ é”ï¼Œå› æ­¤å¯ä»¥ç»§ç»­è®©å®ƒè·å–è¯»é”ï¼Œå½“å®ƒåŒæ—¶è·å–äº†å†™é”å’Œè¯»é”åï¼Œè¿˜å¯ä»¥å…ˆé‡Š æ”¾å†™é”ç»§ç»­æŒæœ‰è¯»é”ï¼Œè¿™æ ·ä¸€ä¸ªå†™é”å°±â€œé™çº§â€ä¸ºäº†è¯»é”ã€‚



## 8.2 æ‚²è§‚é”

æ‚²è§‚é”æ˜¯ä¸€ç§ä¿å®ˆçš„é”ç­–ç•¥ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå‡å®šå…¶ä»–çº¿ç¨‹ä¼šå¯¹è¯¥èµ„æºè¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤é‡‡å–åŠ é”çš„æ–¹å¼é˜²æ­¢å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°ã€‚æ‚²è§‚é”å¸¸è§çš„å®ç°æ–¹å¼æ˜¯ä½¿ç”¨ synchronized å…³é”®å­—æˆ–è€… ReentrantLock ç­‰é”å¯¹è±¡ã€‚

> å½“ä¸€ä¸ªäººè¿›è¡Œæ“ä½œæ—¶ä¼šä¸Šé”ï¼Œé˜»å¡åˆ«äººï¼Œå…¶ä»–äººå°±ä¸èƒ½è¿›è¡Œæ“ä½œï¼Œåªæœ‰å½“è¿™ä¸ªäººæŠŠé”é‡Šæ”¾æ‰ï¼Œå…¶ä»–äººæ‰å¯ä»¥è¿›è¡Œæ“ä½œï¼Œå½“å…¶ä»–äººæ“ä½œæ—¶ä¹Ÿä¼šé‡å¤ä»¥ä¸Šçš„æ­¥éª¤ã€‚

æ‚²è§‚é”çš„ä¼˜ç‚¹ï¼š

1. å¯ä»¥ä¿è¯å¹¶å‘è®¿é—®çš„å®‰å…¨æ€§ï¼Œé¿å…æ•°æ®çš„è„è¯»ã€å¹»è¯»ç­‰é—®é¢˜ï¼›
2. æ‚²è§‚é”é€‚ç”¨äºå†™æ“ä½œå¤šã€è¯»æ“ä½œå°‘çš„åœºæ™¯ï¼Œå¯ä»¥å‡å°‘å†™å†²çªçš„å‘ç”Ÿï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

æ‚²è§‚é”çš„ç¼ºç‚¹ï¼š

1. æ‚²è§‚é”ä¼šåœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œé˜»å¡å…¶ä»–çº¿ç¨‹çš„è®¿é—®ï¼Œé™ä½å¹¶å‘æ€§èƒ½ï¼›
2. ä¸æ”¯æŒå¹¶å‘æ“ä½œï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„è¿›è¡Œæ“ä½œï¼Œå¯¼è‡´æ•ˆç‡æ€§èƒ½é™ä½ã€‚
3. æ‚²è§‚é”å¯¹æ€§èƒ½çš„å½±å“å’ŒåŠ é”çš„èŒƒå›´æœ‰å…³ï¼ŒåŠ é”èŒƒå›´è¿‡å¤§ï¼Œä¼šå¯¼è‡´å¹¶å‘æ€§èƒ½ä¸‹é™ï¼›
4. å¦‚æœæ‚²è§‚é”çš„åŠ é”ç²’åº¦å¤ªå°ï¼Œä¼šå¯¼è‡´çº¿ç¨‹é¢‘ç¹åŠ é”å’Œé‡Šæ”¾é”ï¼Œä»è€Œé€ æˆæ€§èƒ½ç“¶é¢ˆã€‚

æ€»çš„æ¥è¯´ï¼Œæ‚²è§‚é”è™½ç„¶èƒ½å¤Ÿ==ä¿è¯å¹¶å‘è®¿é—®çš„å®‰å…¨æ€§==ï¼Œä½†æ˜¯åœ¨==é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜==ï¼Œéœ€è¦å¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºè®¾è®¡æ—¶è¿›è¡Œæƒè¡¡ï¼Œé€‰æ‹©é€‚åˆçš„é”ç­–ç•¥æ¥æé«˜å¹¶å‘æ€§èƒ½



## 8.3 ä¹è§‚é”

ä¹è§‚é”æ˜¯ä¸€ç§ä¹è§‚çš„é”ç­–ç•¥ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å‡è®¾åœ¨å¹¶å‘è®¿é—®æ—¶ï¼Œå…±äº«èµ„æºä¸ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤ä¸ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹çš„è®¿é—®ï¼Œè€Œæ˜¯åœ¨æ›´æ–°å…±äº«èµ„æºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å¯¹è¯¥èµ„æºè¿›è¡Œä¿®æ”¹ã€‚ä¹è§‚é”å¸¸è§çš„å®ç°æ–¹å¼æœ‰ç‰ˆæœ¬å·æœºåˆ¶å’ŒCASï¼ˆCompare And Swapï¼‰ç®—æ³•ç­‰ã€‚

ä¹è§‚é”çš„ä¼˜ç‚¹ï¼š

1. åœ¨å¹¶å‘è¯»æ“ä½œå¤šã€å†™æ“ä½œå°‘çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚é”å¯ä»¥æé«˜å¹¶å‘æ€§èƒ½ï¼›
2. ä¹è§‚é”ä¸ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹çš„è®¿é—®ï¼Œé¿å…äº†åŠ é”çš„å¼€é”€ï¼›
3. ä¹è§‚é”çš„å®ç°æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œå®ç°æˆæœ¬ä½ã€‚

ä¹è§‚é”çš„ç¼ºç‚¹ï¼š

1. ä¹è§‚é”ä¸èƒ½ä¿è¯å¹¶å‘è®¿é—®çš„å®‰å…¨æ€§ï¼Œå­˜åœ¨æ•°æ®çš„å†²çªã€ä¸¢å¤±ç­‰é—®é¢˜ï¼›
2. ä¹è§‚é”çš„å®ç°æ–¹å¼==éœ€è¦åœ¨æ›´æ–°å…±äº«èµ„æºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°==ï¼Œå¦‚æœå­˜åœ¨å¹²æ‰°éœ€è¦è¿›è¡Œé‡è¯•ï¼Œè¿™ä¼šå¢åŠ ä¸€å®šçš„å¼€é”€ï¼›
3. ä¹è§‚é”çš„é€‚ç”¨åœºæ™¯æœ‰é™ï¼Œä¸é€‚ç”¨äºå†™æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„åœºæ™¯ã€‚

æ€»çš„æ¥è¯´ï¼Œä¹è§‚é”åœ¨ä¸€äº›==è¯»æ“ä½œå¤šã€å†™æ“ä½œå°‘çš„åœºæ™¯ä¸‹å¯ä»¥æé«˜å¹¶å‘æ€§èƒ½==ï¼Œä½†æ˜¯åœ¨ä¸€äº›==é«˜å¹¶å‘å†™æ“ä½œçš„åœºæ™¯ä¸‹å¯èƒ½ä¼šå¯¼è‡´æ•°æ®å†²çª==ï¼Œéœ€è¦å¼€å‘è€…åœ¨å®é™…åº”ç”¨ä¸­è¿›è¡Œè¯„ä¼°å’Œé€‰æ‹©ã€‚



## 8.4 è¡¨é”ã€è¡Œé”

è¡¨é”æ˜¯æŒ‡å¯¹æ•´ä¸ªè¡¨è¿›è¡ŒåŠ é”ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡è®¿é—®æŸä¸ªè¡¨æ—¶ï¼Œä¼šå¯¹æ•´ä¸ªè¡¨è¿›è¡ŒåŠ é”ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•å¯¹è¯¥è¡¨è¿›è¡Œæ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œã€‚

ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œå¯¹äºä¸€äº›åªè¯»çš„æ“ä½œå¯ä»¥æé«˜å¹¶å‘æ€§èƒ½ï¼Œ

ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½è¾ƒä½ï¼Œä¼šå¯¹æ•´ä¸ªè¡¨è¿›è¡ŒåŠ é”ï¼Œå½±å“å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚



è¡Œé”æ˜¯æŒ‡å¯¹è¡¨ä¸­çš„ä¸€è¡Œæˆ–å¤šè¡Œè¿›è¡ŒåŠ é”ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡è®¿é—®æŸä¸ªè¡¨æ—¶ï¼Œåªå¯¹éœ€è¦è®¿é—®çš„è¡Œè¿›è¡ŒåŠ é”ï¼Œå…¶ä»–è¡Œä¸å—å½±å“ã€‚

ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½è¾ƒé«˜ï¼Œåªå¯¹éœ€è¦è®¿é—®çš„è¡Œè¿›è¡ŒåŠ é”ï¼Œä¸ä¼šå½±å“å…¶ä»–äº‹åŠ¡çš„æ“ä½œ

ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦ä¿è¯è¡Œçº§é”çš„ç²’åº¦ä¸ä¼šè¿‡ç»†ï¼Œå¦åˆ™ä¼šé™ä½å¹¶å‘æ€§èƒ½ï¼Œå¯èƒ½ä¼šå‡ºç°æ­»é”çŠ¶æ€ã€‚

> åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¦‚æœåªæœ‰è¯»æ“ä½œï¼Œå¯ä»¥é‡‡ç”¨è¡¨é”æé«˜å¹¶å‘æ€§èƒ½ï¼›å¦‚æœæœ‰è¾ƒå¤šçš„å†™æ“ä½œï¼Œåº”è¯¥é‡‡ç”¨è¡Œé”é¿å…æ•°æ®å†²çªã€‚åœ¨å®ç°è¡Œé”æ—¶ï¼Œéœ€è¦æ³¨æ„é”ç²’åº¦çš„é—®é¢˜ï¼Œé¿å…é”å®šè¿‡ç»†æˆ–è¿‡ç²—ã€‚åŒæ—¶ï¼Œä¸ºäº†æé«˜å¹¶å‘æ€§èƒ½ï¼Œå¯ä»¥é‡‡ç”¨ä¸€äº›è¾…åŠ©æ‰‹æ®µï¼Œå¦‚ç¼“å­˜ã€ç´¢å¼•ç­‰ã€‚
>



# 9ã€JUCé˜»å¡é˜Ÿåˆ—

## 9.1 BlockingQueue ç®€ä»‹

Concurrent åŒ…ä¸­ï¼ŒBlockingQueue å¾ˆå¥½çš„è§£å†³äº†å¤šçº¿ç¨‹ä¸­ï¼Œå¦‚ä½•é«˜æ•ˆå®‰å…¨ â€œä¼ è¾“â€æ•°æ®çš„é—®é¢˜ã€‚é€šè¿‡è¿™äº›é«˜æ•ˆå¹¶ä¸”çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ç±»ï¼Œä¸ºæˆ‘ä»¬å¿«é€Ÿæ­å»º é«˜è´¨é‡çš„å¤šçº¿ç¨‹ç¨‹åºå¸¦æ¥æå¤§çš„ä¾¿åˆ©ã€‚

é˜»å¡é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ï¼Œ é€šè¿‡ä¸€ä¸ªå…±äº«çš„é˜Ÿåˆ—ï¼Œå¯ä»¥ä½¿å¾—æ•°æ®ç”±é˜Ÿåˆ—çš„ä¸€ç«¯è¾“å…¥ï¼Œä»å¦å¤–ä¸€ç«¯è¾“å‡ºï¼›

![image-20230222112840222](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222112840222.png)



- å½“é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ 
- å½“é˜Ÿåˆ—æ˜¯æ»¡çš„ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ 
- è¯•å›¾ä»ç©ºçš„é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´  
- è¯•å›¾å‘å·²æ»¡çš„é˜Ÿåˆ—ä¸­æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æˆ–è€…å®Œå…¨æ¸…ç©ºï¼Œä½¿é˜Ÿåˆ—å˜å¾—ç©ºé—²èµ·æ¥å¹¶åç»­æ–°å¢

å¸¸ç”¨çš„é˜Ÿåˆ—ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š

- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ï¼šå…ˆæ’å…¥çš„é˜Ÿåˆ—çš„å…ƒç´ ä¹Ÿæœ€å…ˆå‡ºé˜Ÿåˆ—ï¼Œç±»ä¼¼äºæ’é˜Ÿçš„åŠŸèƒ½ã€‚ ä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´è¿™ç§é˜Ÿåˆ—ä¹Ÿä½“ç°äº†ä¸€ç§å…¬å¹³æ€§
- åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰ï¼šåæ’å…¥é˜Ÿåˆ—çš„å…ƒç´ æœ€å…ˆå‡ºé˜Ÿåˆ—ï¼Œè¿™ç§é˜Ÿåˆ—ä¼˜å…ˆå¤„ç†æœ€è¿‘å‘ ç”Ÿçš„äº‹ä»¶(æ ˆ)



### 9.1.1 å¤šçº¿ç¨‹çš„é˜»å¡

åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ· çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤èµ·ã€‚

ä½¿ç”¨ BlockingQueue å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¸€åˆ‡ BlockingQueue éƒ½ç»™ä½ ä¸€æ‰‹åŒ…åŠäº†

åœ¨ concurrent åŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»å»è‡ªå·±æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦ã€‚

> å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œé€šè¿‡é˜Ÿåˆ—å¯ä»¥å¾ˆå®¹æ˜“å®ç°æ•°æ®å…±äº«ï¼Œæ¯”å¦‚ç»å…¸çš„â€œç”Ÿäº§è€…â€å’Œ â€œæ¶ˆè´¹è€…â€æ¨¡å‹ä¸­ï¼Œé€šè¿‡é˜Ÿåˆ—å¯ä»¥å¾ˆä¾¿åˆ©åœ°å®ç°ä¸¤è€…ä¹‹é—´çš„æ•°æ®å…±äº«ã€‚å‡è®¾æˆ‘ä»¬æœ‰è‹¥å¹²ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå¦å¤–åˆæœ‰è‹¥å¹²ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ã€‚å¦‚æœç”Ÿäº§è€…çº¿ç¨‹éœ€è¦æŠŠå‡† å¤‡å¥½çš„æ•°æ®å…±äº«ç»™æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œåˆ©ç”¨é˜Ÿåˆ—çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ° è§£å†³ä»–ä»¬ä¹‹é—´çš„æ•°æ®å…±äº«é—®é¢˜ã€‚ä½†å¦‚æœç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åœ¨æŸä¸ªæ—¶é—´æ®µå†…ï¼Œä¸‡ä¸€ å‘ç”Ÿæ•°æ®å¤„ç†é€Ÿåº¦ä¸åŒ¹é…çš„æƒ…å†µå‘¢ï¼Ÿç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœç”Ÿäº§è€…äº§å‡ºæ•°æ®çš„é€Ÿåº¦ å¤§äºæ¶ˆè´¹è€…æ¶ˆè´¹çš„é€Ÿåº¦ï¼Œå¹¶ä¸”å½“ç”Ÿäº§å‡ºæ¥çš„æ•°æ®ç´¯ç§¯åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ï¼Œé‚£ä¹ˆ ç”Ÿäº§è€…å¿…é¡»æš‚åœç­‰å¾…ä¸€ä¸‹ï¼ˆé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼‰ï¼Œä»¥ä¾¿ç­‰å¾…æ¶ˆè´¹è€…çº¿ç¨‹æŠŠç´¯ç§¯çš„ æ•°æ®å¤„ç†å®Œæ¯•ï¼Œåä¹‹äº¦ç„¶ã€‚

- å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…ç«¯çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¢«è‡ªåŠ¨é˜»å¡ï¼ˆæŒ‚èµ·ï¼‰ï¼Œ ç›´åˆ°æœ‰æ•°æ®æ”¾å…¥é˜Ÿåˆ— 
- å½“é˜Ÿåˆ—ä¸­å¡«æ»¡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…ç«¯çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè¢«è‡ªåŠ¨é˜»å¡ï¼ˆæŒ‚èµ·ï¼‰ï¼Œ ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ç©ºçš„ä½ç½®ï¼Œçº¿ç¨‹è¢«è‡ªåŠ¨å”¤é†’



## 9.2 BlockingQueue æ ¸å¿ƒæ–¹æ³•

![image-20230222121403239](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222121403239.png)

### 9.2.1 æ”¾å…¥æ•°æ®

- `offer(anObject)`ï¼šè¡¨ç¤ºå¦‚æœå¯èƒ½çš„è¯ï¼Œå°† anObject åŠ åˆ° BlockingQueue é‡Œï¼Œå³ å¦‚æœ BlockingQueue å¯ä»¥å®¹çº³,åˆ™è¿”å› true,å¦åˆ™è¿”å› false.ï¼ˆæœ¬æ–¹æ³•ä¸é˜»å¡å½“ å‰æ‰§è¡Œæ–¹æ³•çš„çº¿ç¨‹ï¼‰ 
- `offer(E o, long timeout, TimeUnit unit)`ï¼šå¯ä»¥è®¾å®šç­‰å¾…çš„æ—¶é—´ï¼Œå¦‚æœåœ¨æŒ‡å®š çš„æ—¶é—´å†…ï¼Œè¿˜ä¸èƒ½å¾€é˜Ÿåˆ—ä¸­åŠ å…¥ BlockingQueueï¼Œåˆ™è¿”å›å¤±è´¥ 
- `put(anObject)`ï¼šæŠŠ anObject åŠ åˆ° BlockingQueue é‡Œï¼Œå¦‚æœ BlockQueue æ²¡æœ‰ç©ºé—´,åˆ™è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹è¢«é˜»æ–­ç›´åˆ° BlockingQueue é‡Œé¢æœ‰ç©ºé—´å†ç»§ç»­

### 9.2.2 è·å–æ•°æ®

- `poll(time)`ï¼šå–èµ° BlockingQueue é‡Œæ’åœ¨é¦–ä½çš„å¯¹è±¡,è‹¥ä¸èƒ½ç«‹å³å–å‡º,åˆ™å¯ä»¥ç­‰ time å‚æ•°è§„å®šçš„æ—¶é—´,å–ä¸åˆ°æ—¶è¿”å› null
- `poll(long timeout, TimeUnit unit)`ï¼šä» BlockingQueue å–å‡ºä¸€ä¸ªé˜Ÿé¦–çš„å¯¹è±¡ï¼Œ å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œé˜Ÿåˆ—ä¸€æ—¦æœ‰æ•°æ®å¯å–ï¼Œåˆ™ç«‹å³è¿”å›é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚å¦åˆ™çŸ¥ é“æ—¶é—´è¶…æ—¶è¿˜æ²¡æœ‰æ•°æ®å¯å–ï¼Œè¿”å›å¤±è´¥ã€‚  
- `take()`ï¼šå–èµ° BlockingQueue é‡Œæ’åœ¨é¦–ä½çš„å¯¹è±¡,è‹¥ BlockingQueue ä¸ºç©º,é˜»æ–­ è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ° BlockingQueue æœ‰æ–°çš„æ•°æ®è¢«åŠ å…¥; 
- `drainTo()`ï¼šä¸€æ¬¡æ€§ä» BlockingQueue è·å–æ‰€æœ‰å¯ç”¨çš„æ•°æ®å¯¹è±¡ï¼ˆè¿˜å¯ä»¥æŒ‡å®š è·å–æ•°æ®çš„ä¸ªæ•°ï¼‰ï¼Œé€šè¿‡è¯¥æ–¹æ³•ï¼Œå¯ä»¥æå‡è·å–æ•°æ®æ•ˆç‡ï¼›ä¸éœ€è¦å¤šæ¬¡åˆ†æ‰¹åŠ  é”æˆ–é‡Šæ”¾é”ã€‚

```java
// åˆ›å»ºä¸€ä¸ªBlockingQueueå¯¹è±¡
ArrayBlockingQueue<String> blockingQueue = new ArrayBlockingQueue<>(2);

// ç¬¬ä¸€ç»„
System.out.println(blockingQueue.add("a"));
System.out.println(blockingQueue.add("cc"));
System.out.println(blockingQueue.element());  // æŸ¥çœ‹ç¬¬ä¸€ä¸ªå…ƒç´ æ·»åŠ æ˜¯å¦æˆåŠŸ
// System.out.println(blockingQueue.add("b")); // è¶…å‡ºå®¹é‡ï¼ŒæŠ¥é”™
System.out.println(blockingQueue.remove());
System.out.println(blockingQueue.remove());
System.out.println(blockingQueue.remove());// æŠ¥é”™
// ç¬¬äºŒç»„
System.out.println(blockingQueue.offer("c"));
System.out.println(blockingQueue.offer("2"));
System.out.println(blockingQueue.offer("3")); // æŠ¥é”™
System.out.println(blockingQueue.poll());
System.out.println(blockingQueue.poll());
System.out.println(blockingQueue.poll());// æŠ¥é”™

// ç¬¬ä¸‰ç»„
blockingQueue.put("dd1");
blockingQueue.put("dd2");
blockingQueue.put("dd3");// æŠ¥é”™
System.out.println(blockingQueue.take());
System.out.println(blockingQueue.take());
System.out.println(blockingQueue.take());// æŠ¥é”™

//ç¬¬å››ç»„
System.out.println(blockingQueue.offer("a"));
System.out.println(blockingQueue.offer("cc"));
blockingQueue.offer("asdc", 3L, TimeUnit.SECONDS);// æŠ¥é”™
```

## 9.3 BlockingQueue  å®ç°ç±»

### 9.3.1 ArrayBlockingQueue(å¸¸ç”¨) 

- ç”±æ•°ç»„ç»“æ„ç»„æˆçš„==æœ‰ç•Œé˜»å¡é˜Ÿåˆ—==

### 9.3.2  LinkedBlockingQueue(å¸¸ç”¨)

-  ç”±==é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œ==ï¼ˆä½†å¤§å°é»˜è®¤å€¼ä¸º integer.MAX_VALUEï¼‰é˜»å¡é˜Ÿåˆ—

ArrayBlockingQueue å’Œ LinkedBlockingQueue æ˜¯ä¸¤ä¸ªæœ€æ™®é€šä¹Ÿæ˜¯æœ€å¸¸ç”¨ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨å¤„ç†å¤šçº¿ç¨‹é—´çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ª ç±»è¶³ä»¥ã€‚

### 9.3.3 DelayQueue

-  ==ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—==

### 9.3.4 PriorityBlockingQueue

åŸºäºä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§çš„åˆ¤æ–­é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥çš„ Compator å¯¹è±¡æ¥ å†³å®šï¼‰ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ PriorityBlockingQueue å¹¶ä¸ä¼šé˜»å¡æ•°æ®ç”Ÿäº§è€…ï¼Œè€Œåªä¼šåœ¨æ²¡æœ‰å¯æ¶ˆè´¹çš„æ•°æ®æ—¶ï¼Œé˜»å¡æ•°æ®çš„æ¶ˆè´¹è€…ã€‚ å› æ­¤ä½¿ç”¨çš„æ—¶å€™è¦ç‰¹åˆ«æ³¨æ„ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ•°æ®çš„é€Ÿåº¦ç»å¯¹ä¸èƒ½å¿«äºæ¶ˆè´¹è€…æ¶ˆè´¹ æ•°æ®çš„é€Ÿåº¦ï¼Œå¦åˆ™æ—¶é—´ä¸€é•¿ï¼Œä¼šæœ€ç»ˆè€—å°½æ‰€æœ‰çš„å¯ç”¨å †å†…å­˜ç©ºé—´ã€‚

åœ¨å®ç° PriorityBlockingQueue æ—¶ï¼Œå†…éƒ¨æ§åˆ¶çº¿ç¨‹åŒæ­¥çš„é”é‡‡ç”¨çš„æ˜¯å…¬å¹³é”

- ==æ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—==

### 9.3.5 SynchronousQueue

- ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³==å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—==

### 9.3.6 LinkedTransferQueue

-  ç”±é“¾è¡¨ç»„æˆçš„==æ— ç•Œé˜»å¡é˜Ÿåˆ—==

### 9.3.7 LinkedBlockingDeque

- ç”±é“¾è¡¨ç»„æˆçš„==åŒå‘é˜»å¡é˜Ÿåˆ—==

## 9.4 æ€»ç»“

åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤èµ·



# 10ã€çº¿ç¨‹æ± 

## 10.1 çº¿ç¨‹æ± ç®€ä»‹

çº¿ç¨‹æ± ï¼ˆè‹±è¯­ï¼šthread poolï¼‰ï¼šä¸€ç§çº¿ç¨‹ä½¿ç”¨æ¨¡å¼ã€‚

çº¿ç¨‹æ± æ˜¯ä¸€ä¸ªç»´æŠ¤çº¿ç¨‹çš„æ± å­ï¼Œå¯ä»¥åœ¨éœ€è¦æ—¶åŠ¨æ€åœ°åˆ›å»ºå’Œå›æ”¶çº¿ç¨‹ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ï¼Œæé«˜äº†çº¿ç¨‹çš„å¤ç”¨æ€§å’Œå¹¶å‘æ€§èƒ½ã€‚

çº¿ç¨‹æ± é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š

1. ä»»åŠ¡é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚
2. çº¿ç¨‹æ± ç®¡ç†å™¨ï¼šç”¨äºç®¡ç†çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯ã€ç›‘æ§ç­‰ã€‚
3. çº¿ç¨‹å·¥å‚ï¼šç”¨äºåˆ›å»ºçº¿ç¨‹ã€‚
4. çº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼šç”¨äºæäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚

çº¿ç¨‹æ± çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š

1. é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ï¼Œæé«˜äº†çº¿ç¨‹çš„å¤ç”¨æ€§å’Œå¹¶å‘æ€§èƒ½ã€‚
2. å¯ä»¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œé¿å…å› è¿‡å¤šçº¿ç¨‹å¯¼è‡´ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æˆ–èµ„æºè€—å°½çš„é—®é¢˜ã€‚
3. å¯ä»¥æä¾›çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„ç›‘æ§ã€ç»Ÿè®¡å’Œå¼‚å¸¸å¤„ç†ç­‰ã€‚

çº¿ç¨‹æ± çš„ç¼ºç‚¹ä¸»è¦åœ¨äºå¯¹äºä»»åŠ¡å¤„ç†æ—¶é—´è¾ƒçŸ­çš„åœºæ™¯ä¸­ï¼Œçº¿ç¨‹æ± çš„å¼€é”€å¯èƒ½ä¼šæ¯”çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€æ›´å¤§ã€‚æ­¤å¤–ï¼Œçº¿ç¨‹æ± çš„å¹¶å‘åº¦éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œå¦‚æœå¹¶å‘åº¦è¿‡é«˜ä¼šå¯¼è‡´ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œåä¹‹åˆ™ä¼šå½±å“ç³»ç»Ÿçš„æ€§èƒ½ã€‚

åœ¨ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé…ç½®ï¼ŒåŒ…æ‹¬çº¿ç¨‹æ± çš„å¤§å°ã€ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€æ‹’ç»ç­–ç•¥ç­‰ã€‚åŒæ—¶ï¼Œè¿˜éœ€è¦æ³¨æ„çº¿ç¨‹æ± çš„å¹¶å‘åº¦å’Œèµ„æºä½¿ç”¨æƒ…å†µï¼Œé¿å…å› è¿‡åº¦ä½¿ç”¨çº¿ç¨‹æ± å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–æ€§èƒ½ä¸‹é™ã€‚





## 10.2 çº¿ç¨‹æ± çš„ä½¿ç”¨æ–¹å¼

> çº¿ç¨‹æ± å¯ä»¥é€šè¿‡è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ã€ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€æ‹’ç»ç­–ç•¥ç­‰å‚æ•°æ¥ä¼˜åŒ–çº¿ç¨‹æ± çš„æ€§èƒ½ã€‚åŒæ—¶ï¼Œåœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çº¿ç¨‹æ± çš„å¹¶å‘åº¦å’Œèµ„æºä½¿ç”¨æƒ…å†µï¼Œé¿å…å› è¿‡åº¦ä½¿ç”¨çº¿ç¨‹æ± å¯¼è‡´ç³»ç»Ÿå´©æºƒæˆ–æ€§èƒ½ä¸‹é™ã€‚

### 10.2.1 ä¸€æ± Nçº¿ç¨‹ newFixedThreadPool(å¸¸ç”¨)

1. åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼šé€šè¿‡çº¿ç¨‹æ± å·¥å‚ç±»çš„é™æ€æ–¹æ³•åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ï¼Œä¾‹å¦‚é€šè¿‡Executorsç±»çš„é™æ€æ–¹æ³•åˆ›å»ºã€‚

   ~~~java
   ExecutorService executor = Executors.newFixedThreadPool(10);
   ~~~

2. æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼šé€šè¿‡çº¿ç¨‹æ± çš„execute()æ–¹æ³•æˆ–submit()æ–¹æ³•æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚

   ~~~java
   executor.execute(new Runnable() {
       @Override
       public void run() {
           // æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡
       }
   });
   
   Future<String> future = executor.submit(new Callable<String>() {
       @Override
       public String call() throws Exception {
           // æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ï¼Œè¿”å›ç»“æœ
           return "result";
       }
   });
   ~~~

3. å…³é—­çº¿ç¨‹æ± ï¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œé€šè¿‡çº¿ç¨‹æ± çš„shutdown()æ–¹æ³•å…³é—­çº¿ç¨‹æ± ï¼Œé˜²æ­¢æ–°çš„ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­ã€‚

   ~~~java
   executor.shutdown();
   ~~~

#### ç‰¹ç‚¹

1. çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¤„äºä¸€å®šçš„é‡ï¼Œå¯ä»¥å¾ˆå¥½çš„æ§åˆ¶çº¿ç¨‹çš„å¹¶å‘é‡ 
2. çº¿ç¨‹å¯ä»¥é‡å¤è¢«ä½¿ç”¨ï¼Œåœ¨æ˜¾ç¤ºå…³é—­ä¹‹å‰ï¼Œéƒ½å°†ä¸€ç›´å­˜åœ¨ 
3. è¶…å‡ºä¸€å®šé‡çš„çº¿ç¨‹è¢«æäº¤æ—¶å€™éœ€åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…

åœºæ™¯: é€‚ç”¨äºå¯ä»¥é¢„æµ‹çº¿ç¨‹æ•°é‡çš„ä¸šåŠ¡ä¸­ï¼Œæˆ–è€…æœåŠ¡å™¨è´Ÿè½½è¾ƒé‡ï¼Œå¯¹çº¿ç¨‹æ•°æœ‰ä¸¥ æ ¼é™åˆ¶çš„åœºæ™¯



### 10.2.2 newCachedThreadPool(å¸¸ç”¨)

- åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©º é—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºçº¿ç¨‹
- å¯æ‰©å®¹çº¿ç¨‹æ± å¤§å°ã€‚

#### ç‰¹ç‚¹

- çº¿ç¨‹æ± ä¸­æ•°é‡æ²¡æœ‰å›ºå®šï¼Œå¯è¾¾åˆ°æœ€å¤§å€¼ï¼ˆInterger. MAX_VALUEï¼‰ 
- çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯è¿›è¡Œç¼“å­˜é‡å¤åˆ©ç”¨å’Œå›æ”¶ï¼ˆå›æ”¶é»˜è®¤æ—¶é—´ä¸º 1 åˆ†é’Ÿï¼‰ 
- å½“çº¿ç¨‹æ± ä¸­ï¼Œæ²¡æœ‰å¯ç”¨çº¿ç¨‹ï¼Œä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹

åœºæ™¯: é€‚ç”¨äºåˆ›å»ºä¸€ä¸ªå¯æ— é™æ‰©å¤§çš„çº¿ç¨‹æ± ï¼ŒæœåŠ¡å™¨è´Ÿè½½å‹åŠ›è¾ƒè½»ï¼Œæ‰§è¡Œæ—¶é—´è¾ƒçŸ­ï¼Œä»»åŠ¡å¤šçš„åœºæ™¯ã€‚



### 10.2.3 newSingleThreadExecutor(å¸¸ç”¨)

- åˆ›å»ºä¸€ä¸ªä½¿ç”¨å•ä¸ª worker çº¿ç¨‹çš„ Executorï¼Œä»¥æ— ç•Œé˜Ÿåˆ—æ–¹å¼æ¥è¿è¡Œè¯¥çº¿ç¨‹ã€‚
- ä¸€æ± ä¸€çº¿ç¨‹

#### ç‰¹ç‚¹

- çº¿ç¨‹æ± ä¸­æœ€å¤šæ‰§è¡Œ 1 ä¸ªçº¿ç¨‹ï¼Œä¹‹åæäº¤çš„çº¿ç¨‹æ´»åŠ¨å°†ä¼šæ’åœ¨é˜Ÿåˆ—ä¸­ä»¥æ­¤æ‰§è¡Œ

åœºæ™¯: é€‚ç”¨äºéœ€è¦ä¿è¯é¡ºåºæ‰§è¡Œå„ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œä¸ä¼šåŒæ—¶æœ‰å¤šä¸ª çº¿ç¨‹çš„åœºæ™¯



### ä¸‰ä¸ªçº¿ç¨‹çš„ä½¿ç”¨æ–¹å¼ï¼š

~~~java
/**
 * @author Shier 2023/2/22 13:11
 */
public class ThreadPollDemo1 {
    public static void main(String[] args) {
        // ä¸€æ± Nçº¿ç¨‹
        // åˆ›å»ºçº¿ç¨‹æ± 
        ExecutorService executorService1 = Executors.newFixedThreadPool(3);
        // ä¸€æ± ä¸€çº¿ç¨‹
        ExecutorService executorService2 = Executors.newSingleThreadExecutor();
        // ä¸€æ± å¯æ‰©å®¹çº¿ç¨‹
        ExecutorService executorService3 = Executors.newCachedThreadPool();
        
        try {
            for (int i = 1; i <= 5; i++) {
                // æ‰§è¡Œçº¿ç¨‹
                executorService1.execute(() -> {
                    System.out.println(Thread.currentThread().getName() + "å·çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ...");
                });
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // å…³é—­çº¿ç¨‹æ± 
            executorService1.shutdown();
        }

    }
}
~~~



## 10.3  çº¿ç¨‹æ± çš„ä¸ƒä¸ªå‚æ•°

1. corePoolSizeï¼šçº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•° 
2. maximumPoolSizeï¼šèƒ½å®¹çº³çš„æœ€å¤§çº¿ç¨‹æ•°
3. keepAliveTimeï¼šç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´  
4. unitï¼šå­˜æ´»çš„æ—¶é—´å•ä½
5. workQueueï¼šå­˜æ”¾æäº¤ä½†æœªæ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
6. threadFactoryï¼šåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±» 
7. handlerï¼šç­‰å¾…é˜Ÿåˆ—æ»¡åçš„æ‹’ç»ç­–ç•¥

çº¿ç¨‹æ± ä¸­ï¼Œæœ‰ä¸‰ä¸ªé‡è¦çš„å‚æ•°ï¼Œå†³å®šå½±å“äº†æ‹’ç»ç­–ç•¥ï¼š

1. corePoolSize - æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¹Ÿå³æœ€å°çš„çº¿ç¨‹æ•°
2. workQueue - é˜»å¡é˜Ÿåˆ—
3. maximumPoolSize - æœ€å¤§çº¿ç¨‹æ•° å½“æäº¤ä»»åŠ¡æ•°å¤§äº corePoolSize çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆå°†ä»»åŠ¡æ”¾åˆ° workQueue é˜»å¡é˜Ÿåˆ—ä¸­ã€‚

å½“é˜»å¡é˜Ÿåˆ—é¥±å’Œåï¼Œä¼šæ‰©å……çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ï¼Œç›´åˆ°è¾¾åˆ°maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°é…ç½®ã€‚æ­¤æ—¶ï¼Œå†å¤šä½™çš„ä»»åŠ¡ï¼Œåˆ™ä¼šè§¦å‘çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥äº†ã€‚ æ€»ç»“èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯ä¸€å¥è¯ï¼Œå½“æäº¤çš„ä»»åŠ¡æ•°å¤§äºï¼ˆworkQueue.size() +  maximumPoolSize ï¼‰ï¼Œå°±ä¼šè§¦å‘çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥ã€‚

### 10.3.1 æ‹’ç»ç­–ç•¥(é‡ç‚¹) 

1. CallerRunsPolicyï¼šå½“è§¦å‘æ‹’ç»ç­–ç•¥ï¼Œåªè¦çº¿ç¨‹æ± æ²¡æœ‰å…³é—­çš„è¯ï¼Œåˆ™ä½¿ç”¨è°ƒç”¨ çº¿ç¨‹ç›´æ¥è¿è¡Œä»»åŠ¡ã€‚ä¸€èˆ¬å¹¶å‘æ¯”è¾ƒå°ï¼Œæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œä¸å…è®¸å¤±è´¥ã€‚ä½†æ˜¯ï¼Œç”± äºè°ƒç”¨è€…è‡ªå·±è¿è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æäº¤é€Ÿåº¦è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºé˜»å¡ï¼Œæ€§èƒ½æ•ˆ ç‡ä¸Šå¿…ç„¶çš„æŸå¤±è¾ƒå¤§ ã€‚
2. AbortPolicyï¼šä¸¢å¼ƒä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºæ‹’ç»æ‰§è¡Œ RejectedExecutionException å¼‚å¸¸ ä¿¡æ¯ã€‚çº¿ç¨‹æ± é»˜è®¤çš„æ‹’ç»ç­–ç•¥ã€‚å¿…é¡»å¤„ç†å¥½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦åˆ™ä¼šæ‰“æ–­å½“å‰çš„æ‰§ è¡Œæµç¨‹ï¼Œå½±å“åç»­çš„ä»»åŠ¡æ‰§è¡Œã€‚ 
3. DiscardPolicyï¼š ç›´æ¥ä¸¢å¼ƒï¼Œå…¶ä»–å•¥éƒ½æ²¡æœ‰ 
4. DiscardOldestPolicy: å½“è§¦å‘æ‹’ç»ç­–ç•¥ï¼Œåªè¦çº¿ç¨‹æ± æ²¡æœ‰å…³é—­çš„è¯ï¼Œä¸¢å¼ƒé˜»å¡é˜Ÿåˆ— workQueue ä¸­æœ€è€çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶å°†æ–°ä»»åŠ¡åŠ å…¥

![image-20230222134009491](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/2767/image-20230222134009491.png)

1. åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ºé›¶
2. å½“è°ƒç”¨ execute()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­ï¼š 
   1.  å¦‚ æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼› 
   2. å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº corePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥ é˜Ÿåˆ—ï¼› 
   3. å¦‚æœè¿™ä¸ªæ—¶å€™é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äº maximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼› 
   4. å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹ æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œã€‚ 
3. å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ 
4. å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹ä¼šåˆ¤æ–­ï¼š 
   1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äº corePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ã€‚ 
   2. æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ° corePoolSize çš„å¤§å°ã€‚

è‡ªå®šä¹‰çº¿ç¨‹ç¤ºä¾‹ï¼š

```java
public class ThreadPollDemo2 {
    public static void main(String[] args) {
        // è‡ªå®šä¹‰çº¿ç¨‹æ± 
        ThreadPoolExecutor executor = new ThreadPoolExecutor(2,
                5,
                2L,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(2),
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.AbortPolicy());
        try {
            for (int i = 1; i <= 5; i++) {
                // æ‰§è¡Œçº¿ç¨‹
                executor.execute(() -> {
                    System.out.println(Thread.currentThread().getName() + "å·çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ...");
                });
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // å…³é—­çº¿ç¨‹æ± 
            executor.shutdown();
        }
    }
}
```



# 11ã€Fork/Join æ¡†æ¶

Fork/Join å®ƒå¯ä»¥å°†ä¸€ä¸ªå¤§çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œæœ€åå°†å­ ä»»åŠ¡ç»“æœåˆå¹¶æˆæœ€åçš„è®¡ç®—ç»“æœï¼Œå¹¶è¿›è¡Œè¾“å‡ºã€‚Fork/Join æ¡†æ¶è¦å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š

- Forkï¼šæŠŠä¸€ä¸ªå¤æ‚ä»»åŠ¡è¿›è¡Œåˆ†æ‹†ï¼Œå¤§äº‹åŒ–å° 
- Joinï¼šæŠŠåˆ†æ‹†ä»»åŠ¡çš„ç»“æœè¿›è¡Œåˆå¹¶

## 11.1 ä»»åŠ¡å¤„ç†

1. ä»»åŠ¡åˆ†å‰²ï¼šé¦–å…ˆ Fork/Join æ¡†æ¶éœ€è¦æŠŠå¤§çš„ä»»åŠ¡åˆ†å‰²æˆè¶³å¤Ÿå°çš„å­ä»»åŠ¡ï¼Œå¦‚æœå­ä»»åŠ¡æ¯”è¾ƒå¤§çš„è¯è¿˜è¦å¯¹å­ä»»åŠ¡è¿›è¡Œç»§ç»­åˆ†å‰² 
2. æ‰§è¡Œä»»åŠ¡å¹¶åˆå¹¶ç»“æœï¼šåˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°åŒç«¯é˜Ÿåˆ—é‡Œï¼Œç„¶åå‡ ä¸ªå¯åŠ¨çº¿ç¨‹ åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚
3. å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½æ”¾åœ¨å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œ å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œå–æ•°æ®ï¼Œç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚



## 11.2 Fork æ–¹æ³•

### åŸç†ï¼š

> å½“æˆ‘ä»¬è°ƒç”¨ ForkJoinTask çš„ fork æ–¹æ³•æ—¶ï¼Œç¨‹åºä¼šæŠŠ ä»»åŠ¡æ”¾åœ¨ ForkJoinWorkerThread çš„ pushTask çš„ workQueue ä¸­ï¼Œå¼‚æ­¥åœ° æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œç„¶åç«‹å³è¿”å›ç»“æœ



## 11.3 join æ–¹æ³•

> Join æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è·å–ç»“æœã€‚

å·²å®Œæˆï¼ˆNORMALï¼‰ã€è¢«å–æ¶ˆï¼ˆCANCELLEDï¼‰ã€ä¿¡å·ï¼ˆSIGNALï¼‰å’Œå‡º ç°å¼‚å¸¸ï¼ˆEXCEPTIONALï¼‰

- å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯å·²å®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ä»»åŠ¡ç»“æœ
- å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯è¢«å–æ¶ˆï¼Œåˆ™ç›´æ¥æŠ›å‡º CancellationException 
- å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¯¹åº”çš„å¼‚å¸¸

```java
class MyTask extends RecursiveTask<Integer> {

    // æ‹†åˆ†çš„æ’å€¼ä¸èƒ½è¶…è¿‡10
    private static final Integer VALUE = 10;
    private int left;
    private int right;
    private int result;

    public MyTask(int left, int right) {
        this.left = left;
        this.right = right;
    }

    @Override
    protected Integer compute() {
        // åˆ¤æ–­å·®å€¼
        if ((right - left) <= 10) {
            for (int i = left; i <= right; i++) {
                result += i;
            }
        } else {
            // è¿›ä¸€æ­¥æ‹†åˆ†
            int middle = (left + right) / 2;
            // å·¦æ‹†åˆ†
            MyTask leftTask = new MyTask(left, middle);
            // å³æ‹†åˆ†
            MyTask rightTask = new MyTask(middle + 1, right);

            leftTask.fork();
            rightTask.fork();
            // åˆå¹¶
            result = leftTask.join() + rightTask.join();
        }
        return result;
    }
}

public class AddSum {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        MyTask myTask = new MyTask(0, 100);
        ForkJoinPool forkJoinPool = new ForkJoinPool();
        ForkJoinTask<Integer> submit = forkJoinPool.submit(myTask);
        Integer integer = submit.get();
        System.out.println(integer);
        // å…³é—­
        forkJoinPool.shutdown();
    }
}
```



# 12ã€CompletableFutureå¼‚æ­¥å›è°ƒ

ä½¿ç”¨CompletableFutureå¯ä»¥å°†è€—æ—¶çš„æ“ä½œå¼‚æ­¥æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°æ¥å¤„ç†è®¡ç®—ç»“æœï¼Œä»¥åŠå¤„ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸æƒ…å†µã€‚



## 12.1 æœ‰æ— è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨

```java
public class CompletableFutureDemo {
    public static void main(String[] args) throws ExecutionException, InterruptedException {

        // æ²¡æœ‰è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨
        CompletableFuture<Void> runAsync = CompletableFuture.runAsync(() -> {
            System.out.println(Thread.currentThread().getName() + "*****æ²¡æœ‰è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨æµ‹è¯•");
        });
        runAsync.get();

        // æœ‰è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨
        CompletableFuture<Integer> supplyAsync = CompletableFuture.supplyAsync(() -> {
            System.out.println(Thread.currentThread().getName() + "======æœ‰è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨æµ‹è¯•");
            // int i = 1 / 0;
            return 200;
        });
        supplyAsync.whenComplete((t, u) -> {
            System.out.println("t:" + t); // è¿”å›å€¼
            System.out.println("u:" + u);// å¼‚å¸¸å€¼
        }).get();
    }
}
```



~~~java
CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {
    // æ‰§è¡Œè€—æ—¶çš„è®¡ç®—ï¼Œè¿”å›ç»“æœ
    return 1 + 2;
});

future.thenAccept(result -> {
    // å¤„ç†è®¡ç®—ç»“æœ
    System.out.println("è®¡ç®—ç»“æœä¸ºï¼š" + result);
});

future.exceptionally(ex -> {
    // å¤„ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸æƒ…å†µ
    System.out.println("è®¡ç®—å‡ºé”™ï¼š" + ex.getMessage());
    return null;
});
~~~

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`CompletableFuture.supplyAsync`æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥è®¡ç®—ä»»åŠ¡ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª`Supplier`å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œè€—æ—¶çš„è®¡ç®—å¹¶è¿”å›ç»“æœã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨`thenAccept`æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨è®¡ç®—å®Œæˆåè¢«æ‰§è¡Œï¼Œå¹¶ä¸”ä¼šæ¥æ”¶è®¡ç®—ç»“æœä½œä¸ºå‚æ•°ã€‚æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨`exceptionally`æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨è®¡ç®—å‡ºé”™æ—¶è¢«æ‰§è¡Œï¼Œå¹¶ä¸”ä¼šæ¥æ”¶å¼‚å¸¸ä¿¡æ¯ä½œä¸ºå‚æ•°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`thenAccept`æ–¹æ³•æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…å‡½æ•°ï¼Œå®ƒä¸ä¼šè¿”å›ä»»ä½•å€¼ï¼Œå› æ­¤ä¸èƒ½åœ¨å›è°ƒå‡½æ•°ä¸­ä¿®æ”¹è®¡ç®—ç»“æœã€‚å¦‚æœéœ€è¦åœ¨å›è°ƒå‡½æ•°ä¸­ä¿®æ”¹è®¡ç®—ç»“æœï¼Œå¯ä»¥ä½¿ç”¨`thenApply`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°†è®¡ç®—ç»“æœè½¬æ¢ä¸ºå¦ä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›è½¬æ¢åçš„ç»“æœã€‚





























